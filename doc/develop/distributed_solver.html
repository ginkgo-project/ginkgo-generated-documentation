<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ginkgo: The distributed-solver program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_doc.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Ginkgo
   &#160;<span id="projectnumber">Generated from pipelines/844752355 branch based on develop. Ginkgo version 1.5.0</span>
   </div>
   <div id="projectbrief">A numerical linear algebra library targeting many-core architectures</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The distributed-solver program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The distributed solver example..</p>
<p>This example depends on simple-solver, three-pt-stencil-solver.</p>
<p> 
<table class="example" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#InitializetheMPIenvironment">Initialize the MPI environment</a>
        <li><a href="#TypeDefinitiions">Type Definitiions</a>
        <li><a href="#UserInputHandling">User Input Handling</a>
        <li><a href="#CreatingtheDistributedMatrixandVectors">Creating the Distributed Matrix and Vectors</a>
        <li><a href="#SolvetheDistributedSystem">Solve the Distributed System</a>
        <li><a href="#PrintingResults">Printing Results</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>This distributed solver example should help you understand the basics of using Ginkgo in a distributed setting. The example will solve a simple 1D Laplace equation where the system can be distributed row-wise to multiple processes. To run the solver with multiple processes, use <code>mpirun -n NUM_PROCS ./distributed-solver [executor] [num_grid_points] [num_iterations]</code>.</p>
<p>If you are using GPU devices, please make sure that you run this example with at most as many processes as you have GPU devices available. <a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>This is the main ginkgo header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ginkgo/ginkgo.hpp&gt;</span></div>
</div><!-- fragment --><p>Add the C++ iostream header to output information to the console.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
</div><!-- fragment --><p>Add the STL map header for the executor selection</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
</div><!-- fragment --><p>Add the string manipulation header to handle strings.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
</div><!-- fragment --><p><a class="anchor" id="InitializetheMPIenvironment"></a> </p><h3>Initialize the MPI environment</h3>
<p>Since this is an MPI program, we need to initialize and finalize MPI at the begin and end respectively of our program. This can be easily done with the following helper construct that uses RAII to automate the initialization and finalization.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classgko_1_1experimental_1_1mpi_1_1environment.html">gko::experimental::mpi::environment</a> env(argc, argv);</div>
</div><!-- fragment --><p><a class="anchor" id="TypeDefinitiions"></a> </p><h3>Type Definitiions</h3>
<p>Define the needed types. In a parallel program we need to differentiate beweeen global and local indices, thus we have two index types.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> GlobalIndexType = <a class="code" href="namespacegko.html#a6c57dbf3168b1ecad3ea133aaf2efbc1">gko::int64</a>;</div>
<div class="line"><span class="keyword">using</span> LocalIndexType = <a class="code" href="namespacegko.html#a1ec26caa2379a21a8d0cde611559fff6">gko::int32</a>;</div>
</div><!-- fragment --><p>The underlying value type.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> ValueType = double;</div>
</div><!-- fragment --><p>As vector type we use the following, which implements a subset of <a class="el" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> dist_vec = <a class="code" href="classgko_1_1experimental_1_1distributed_1_1Vector.html">gko::experimental::distributed::Vector&lt;ValueType&gt;</a>;</div>
</div><!-- fragment --><p>As matrix type we simply use the following type, which can read distributed data and be applied to a distributed vector.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> dist_mtx =</div>
<div class="line">    <a class="code" href="classgko_1_1experimental_1_1distributed_1_1Matrix.html">gko::experimental::distributed::Matrix</a>&lt;ValueType, LocalIndexType,</div>
<div class="line">                                           GlobalIndexType&gt;;</div>
</div><!-- fragment --><p>We still need a localized vector type to be used as scalars in the advanced apply operations.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> vec = <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>;</div>
</div><!-- fragment --><p>The partition type describes how the rows of the matrices are distributed.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> part_type =</div>
<div class="line">    <a class="code" href="classgko_1_1experimental_1_1distributed_1_1Partition.html">gko::experimental::distributed::Partition</a>&lt;LocalIndexType,</div>
<div class="line">                                              GlobalIndexType&gt;;</div>
</div><!-- fragment --><p>We can use here the same solver type as you would use in a non-distributed program. Please note that not all solvers support distributed systems at the moment.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="namespacegko_1_1log.html#a15f71654c6c4f4defc95f9359343fa27a7cbf673200498a0d1324f4330825202a">solver</a> = <a class="code" href="classgko_1_1solver_1_1Cg.html">gko::solver::Cg&lt;ValueType&gt;</a>;</div>
<div class="line"><span class="keyword">using</span> schwarz = <a class="code" href="classgko_1_1experimental_1_1distributed_1_1preconditioner_1_1Schwarz.html">gko::experimental::distributed::preconditioner::Schwarz</a>&lt;</div>
<div class="line">    ValueType, LocalIndexType, GlobalIndexType&gt;;</div>
<div class="line"><span class="keyword">using</span> bj = <a class="code" href="classgko_1_1preconditioner_1_1Jacobi.html">gko::preconditioner::Jacobi&lt;ValueType, LocalIndexType&gt;</a>;</div>
</div><!-- fragment --><p>Create an MPI communicator get the rank of the calling process.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> comm = <a class="code" href="classgko_1_1experimental_1_1mpi_1_1communicator.html">gko::experimental::mpi::communicator</a>(MPI_COMM_WORLD);</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> rank = comm.rank();</div>
</div><!-- fragment --><p><a class="anchor" id="UserInputHandling"></a> </p><h3>User Input Handling</h3>
<p>User input settings:</p><ul>
<li>The executor, defaults to reference.</li>
<li>The number of grid points, defaults to 100.</li>
<li>The number of iterations, defaults to 1000.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (argc == 2 &amp;&amp; (std::string(argv[1]) == <span class="stringliteral">&quot;--help&quot;</span>)) {</div>
<div class="line">    <span class="keywordflow">if</span> (rank == 0) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0]</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot; [executor] [num_grid_points] [num_iterations] &quot;</span></div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    std::exit(-1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">ValueType t_init = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> executor_string = argc &gt;= 2 ? argv[1] : <span class="stringliteral">&quot;reference&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> grid_dim =</div>
<div class="line">    static_cast&lt;gko::size_type&gt;(argc &gt;= 3 ? std::atoi(argv[2]) : 100);</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> num_iters =</div>
<div class="line">    static_cast&lt;gko::size_type&gt;(argc &gt;= 4 ? std::atoi(argv[3]) : 1000);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> std::map&lt;std::string,</div>
<div class="line">               std::function&lt;std::shared_ptr&lt;gko::Executor&gt;(MPI_Comm)&gt;&gt;</div>
<div class="line">    executor_factory_mpi{</div>
<div class="line">        {<span class="stringliteral">&quot;reference&quot;</span>,</div>
<div class="line">         [](MPI_Comm) { <span class="keywordflow">return</span> gko::ReferenceExecutor::create(); }},</div>
<div class="line">        {<span class="stringliteral">&quot;omp&quot;</span>, [](MPI_Comm) { <span class="keywordflow">return</span> <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>(); }},</div>
<div class="line">        {<span class="stringliteral">&quot;cuda&quot;</span>,</div>
<div class="line">         [](MPI_Comm comm) {</div>
<div class="line">             <span class="keywordtype">int</span> device_id = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a0ec0c93a068b2c19da8cb5e874bf9f6c">gko::experimental::mpi::map_rank_to_device_id</a>(</div>
<div class="line">                 comm, <a class="code" href="classgko_1_1CudaExecutor.html#aef0258494d14de0e56149b920c5173e5">gko::CudaExecutor::get_num_devices</a>());</div>
<div class="line">             <span class="keywordflow">return</span> <a class="code" href="classgko_1_1CudaExecutor.html#a8e18adb154a44f90c13d61c1e100e160">gko::CudaExecutor::create</a>(</div>
<div class="line">                 device_id, gko::ReferenceExecutor::create(), <span class="keyword">false</span>,</div>
<div class="line">                 gko::allocation_mode::device);</div>
<div class="line">         }},</div>
<div class="line">        {<span class="stringliteral">&quot;hip&quot;</span>,</div>
<div class="line">         [](MPI_Comm comm) {</div>
<div class="line">             <span class="keywordtype">int</span> device_id = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a0ec0c93a068b2c19da8cb5e874bf9f6c">gko::experimental::mpi::map_rank_to_device_id</a>(</div>
<div class="line">                 comm, <a class="code" href="classgko_1_1HipExecutor.html#a7b34cbd84692dafa2290e6630754aa97">gko::HipExecutor::get_num_devices</a>());</div>
<div class="line">             <span class="keywordflow">return</span> <a class="code" href="classgko_1_1HipExecutor.html#a5ace87d0179ef0ef55b60e78e9c2f897">gko::HipExecutor::create</a>(</div>
<div class="line">                 device_id, gko::ReferenceExecutor::create(), <span class="keyword">true</span>);</div>
<div class="line">         }},</div>
<div class="line">        {<span class="stringliteral">&quot;dpcpp&quot;</span>, [](MPI_Comm comm) {</div>
<div class="line">             <span class="keywordtype">int</span> device_id = 0;</div>
<div class="line">             <span class="keywordflow">if</span> (<a class="code" href="classgko_1_1DpcppExecutor.html#adf306338233c8e8aca0dec96aefe5d93">gko::DpcppExecutor::get_num_devices</a>(<span class="stringliteral">&quot;gpu&quot;</span>)) {</div>
<div class="line">                 device_id = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a0ec0c93a068b2c19da8cb5e874bf9f6c">gko::experimental::mpi::map_rank_to_device_id</a>(</div>
<div class="line">                     comm, <a class="code" href="classgko_1_1DpcppExecutor.html#adf306338233c8e8aca0dec96aefe5d93">gko::DpcppExecutor::get_num_devices</a>(<span class="stringliteral">&quot;gpu&quot;</span>));</div>
<div class="line">             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classgko_1_1DpcppExecutor.html#adf306338233c8e8aca0dec96aefe5d93">gko::DpcppExecutor::get_num_devices</a>(<span class="stringliteral">&quot;cpu&quot;</span>)) {</div>
<div class="line">                 device_id = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a0ec0c93a068b2c19da8cb5e874bf9f6c">gko::experimental::mpi::map_rank_to_device_id</a>(</div>
<div class="line">                     comm, <a class="code" href="classgko_1_1DpcppExecutor.html#adf306338233c8e8aca0dec96aefe5d93">gko::DpcppExecutor::get_num_devices</a>(<span class="stringliteral">&quot;cpu&quot;</span>));</div>
<div class="line">             } <span class="keywordflow">else</span> {</div>
<div class="line">                 <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;No suitable DPC++ devices&quot;</span>);</div>
<div class="line">             }</div>
<div class="line">             <span class="keywordflow">return</span> <a class="code" href="classgko_1_1DpcppExecutor.html#ae9b875dfe3af7f3f3f24071bfb2f895e">gko::DpcppExecutor::create</a>(</div>
<div class="line">                 device_id, gko::ReferenceExecutor::create());</div>
<div class="line">         }}};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> exec = executor_factory_mpi.at(executor_string)(MPI_COMM_WORLD);</div>
</div><!-- fragment --><p><a class="anchor" id="CreatingtheDistributedMatrixandVectors"></a> </p><h3>Creating the Distributed Matrix and Vectors</h3>
<p>As a first step, we create a partition of the rows. The partition consists of ranges of consecutive rows which are assigned a part-id. These part-ids will be used for the distributed data structures to determine which rows will be stored locally. In this example each rank has (nearly) the same number of rows, so we can use the following specialized constructor. See gko::distributed::Partition for other modes of creating a partition.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> num_rows = grid_dim;</div>
<div class="line"><span class="keyword">auto</span> partition = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(part_type::build_from_global_size_uniform(</div>
<div class="line">    exec-&gt;get_master(), comm.size(),</div>
<div class="line">    static_cast&lt;GlobalIndexType&gt;(num_rows)));</div>
</div><!-- fragment --><p>Assemble the matrix using a 3-pt stencil and fill the right-hand-side with a sine value. The distributed matrix supports only constructing an empty matrix of zero size and filling in the values with <a class="el" href="classgko_1_1experimental_1_1distributed_1_1Matrix.html#acb4a34395b0ee89e077f4cab66116b90" title="Reads a square matrix from the device_matrix_data structure and a global partition.">gko::experimental::distributed::Matrix::read_distributed</a>. Only the data that belongs to the rows by this rank will be assembled.</p>
<div class="fragment"><div class="line"><a class="code" href="structgko_1_1matrix__data.html">gko::matrix_data&lt;ValueType, GlobalIndexType&gt;</a> A_data;</div>
<div class="line"><a class="code" href="structgko_1_1matrix__data.html">gko::matrix_data&lt;ValueType, GlobalIndexType&gt;</a> b_data;</div>
<div class="line"><a class="code" href="structgko_1_1matrix__data.html">gko::matrix_data&lt;ValueType, GlobalIndexType&gt;</a> x_data;</div>
<div class="line">A_data.<a class="code" href="structgko_1_1matrix__data.html#a30716bd9e39a7beed52fc56d737fc07b">size</a> = {num_rows, num_rows};</div>
<div class="line">b_data.<a class="code" href="structgko_1_1matrix__data.html#a30716bd9e39a7beed52fc56d737fc07b">size</a> = {num_rows, 1};</div>
<div class="line">x_data.<a class="code" href="structgko_1_1matrix__data.html#a30716bd9e39a7beed52fc56d737fc07b">size</a> = {num_rows, 1};</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> range_start = partition-&gt;get_range_bounds()[rank];</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> range_end = partition-&gt;get_range_bounds()[rank + 1];</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = range_start; i &lt; range_end; i++) {</div>
<div class="line">    <span class="keywordflow">if</span> (i &gt; 0) {</div>
<div class="line">        A_data.<a class="code" href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">nonzeros</a>.emplace_back(i, i - 1, -1);</div>
<div class="line">    }</div>
<div class="line">    A_data.<a class="code" href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">nonzeros</a>.emplace_back(i, i, 2);</div>
<div class="line">    <span class="keywordflow">if</span> (i &lt; grid_dim - 1) {</div>
<div class="line">        A_data.<a class="code" href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">nonzeros</a>.emplace_back(i, i + 1, -1);</div>
<div class="line">    }</div>
<div class="line">    b_data.<a class="code" href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">nonzeros</a>.emplace_back(i, 0, std::sin(i * 0.01));</div>
<div class="line">    x_data.<a class="code" href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">nonzeros</a>.emplace_back(i, 0, gko::zero&lt;ValueType&gt;());</div>
<div class="line">}</div>
</div><!-- fragment --><p>Take timings.</p>
<div class="fragment"><div class="line">comm.synchronize();</div>
<div class="line">ValueType t_init_end = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
</div><!-- fragment --><p>Read the matrix data, currently this is only supported on CPU executors. This will also set up the communication pattern needed for the distributed matrix-vector multiplication.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> A_host = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(dist_mtx::create(exec-&gt;get_master(), comm));</div>
<div class="line"><span class="keyword">auto</span> x_host = dist_vec::create(exec-&gt;get_master(), comm);</div>
<div class="line"><span class="keyword">auto</span> b_host = dist_vec::create(exec-&gt;get_master(), comm);</div>
<div class="line">A_host-&gt;read_distributed(A_data, partition);</div>
<div class="line">b_host-&gt;read_distributed(b_data, partition);</div>
<div class="line">x_host-&gt;read_distributed(x_data, partition);</div>
</div><!-- fragment --><p>After reading, the matrix and vector can be moved to the chosen executor, since the distributed matrix supports SpMV also on devices.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> A = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(dist_mtx::create(exec, comm));</div>
<div class="line"><span class="keyword">auto</span> x = dist_vec::create(exec, comm);</div>
<div class="line"><span class="keyword">auto</span> b = dist_vec::create(exec, comm);</div>
<div class="line">A-&gt;copy_from(A_host);</div>
<div class="line">b-&gt;copy_from(b_host);</div>
<div class="line">x-&gt;copy_from(x_host);</div>
</div><!-- fragment --><p>Take timings.</p>
<div class="fragment"><div class="line">comm.synchronize();</div>
<div class="line">ValueType t_read_setup_end = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
</div><!-- fragment --><p><a class="anchor" id="SolvetheDistributedSystem"></a> </p><h3>Solve the Distributed System</h3>
<p>Generate the solver, this is the same as in the non-distributed case. with a local block diagonal preconditioner.</p>
<p>Setup the local block diagonal solver factory.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> local_solver = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(bj::build().on(exec));</div>
</div><!-- fragment --><p>Setup the stopping criterion and logger</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="namespacegko.html#afd46d554050c4ae90e84ea4fcd9a41f3">gko::remove_complex&lt;ValueType&gt;</a> reduction_factor{1e-8};</div>
<div class="line">std::shared_ptr&lt;const gko::log::Convergence&lt;ValueType&gt;&gt; logger =</div>
<div class="line">    <a class="code" href="classgko_1_1log_1_1Convergence.html#abf224a82334775c991f83cfb5e35e18c">gko::log::Convergence&lt;ValueType&gt;::create</a>();</div>
<div class="line"><span class="keyword">auto</span> iter_stop = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(</div>
<div class="line">    gko::stop::Iteration::build().with_max_iters(num_iters).on(exec));</div>
<div class="line"><span class="keyword">auto</span> tol_stop = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(<a class="code" href="classgko_1_1stop_1_1ResidualNorm.html">gko::stop::ResidualNorm&lt;ValueType&gt;::build</a>()</div>
<div class="line">                               .with_reduction_factor(reduction_factor)</div>
<div class="line">                               .on(exec));</div>
<div class="line">iter_stop-&gt;add_logger(logger);</div>
<div class="line">tol_stop-&gt;add_logger(logger);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> Ainv =</div>
<div class="line">    solver::build()</div>
<div class="line">        .with_preconditioner(schwarz::build()</div>
<div class="line">                                 .with_local_solver_factory(local_solver)</div>
<div class="line">                                 .on(exec))</div>
<div class="line">        .with_criteria(iter_stop, tol_stop)</div>
<div class="line">        .on(exec)</div>
<div class="line">        -&gt;generate(A);</div>
</div><!-- fragment --><p>Add logger to the generated solver to log the iteration count and residual norm</p>
<div class="fragment"><div class="line">Ainv-&gt;add_logger(logger);</div>
</div><!-- fragment --><p>Take timings.</p>
<div class="fragment"><div class="line">comm.synchronize();</div>
<div class="line">ValueType t_solver_generate_end = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
</div><!-- fragment --><p>Apply the distributed solver, this is the same as in the non-distributed case.</p>
<div class="fragment"><div class="line">Ainv-&gt;apply(b, x);</div>
</div><!-- fragment --><p>Take timings.</p>
<div class="fragment"><div class="line">comm.synchronize();</div>
<div class="line">ValueType t_solver_apply_end = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
</div><!-- fragment --><p>Compute the residual, this is done in the same way as in the non-distributed case.</p>
<div class="fragment"><div class="line">x_host-&gt;copy_from(x);</div>
<div class="line"><span class="keyword">auto</span> <a class="code" href="namespacegko.html#a0059e27f8f4bc348ff65c1e60caf47c8">one</a> = gko::initialize&lt;vec&gt;({1.0}, exec);</div>
<div class="line"><span class="keyword">auto</span> minus_one = gko::initialize&lt;vec&gt;({-1.0}, exec);</div>
<div class="line">A_host-&gt;apply(minus_one, x_host, one, b_host);</div>
<div class="line"><span class="keyword">auto</span> res_norm = gko::initialize&lt;vec&gt;({0.0}, exec-&gt;get_master());</div>
<div class="line">b_host-&gt;compute_norm2(res_norm);</div>
</div><!-- fragment --><p>Take timings.</p>
<div class="fragment"><div class="line">comm.synchronize();</div>
<div class="line">ValueType t_end = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
</div><!-- fragment --><p><a class="anchor" id="PrintingResults"></a> </p><h3>Printing Results</h3>
<p>Print the achieved residual norm and timings on rank 0.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (comm.rank() == 0) {</div>
</div><!-- fragment --><p>clang-format off</p>
<div class="fragment"><div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;\nNum rows in matrix: &quot;</span> &lt;&lt; num_rows</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;\nNum ranks: &quot;</span> &lt;&lt; comm.size()</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;\nFinal Res norm: &quot;</span> &lt;&lt; *res_norm-&gt;get_values()</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;\nIteration count: &quot;</span> &lt;&lt; logger-&gt;get_num_iterations()</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;\nInit time: &quot;</span> &lt;&lt; t_init_end - t_init</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;\nRead time: &quot;</span> &lt;&lt; t_read_setup_end - t_init</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;\nSolver generate time: &quot;</span> &lt;&lt; t_solver_generate_end - t_read_setup_end</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;\nSolver apply time: &quot;</span> &lt;&lt; t_solver_apply_end - t_solver_generate_end</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;\nTotal time: &quot;</span> &lt;&lt; t_end - t_init</div>
<div class="line">          &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>clang-format on</p>
<div class="fragment"><div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>This is the expected output for <code>mpirun -n 4 ./distributed-solver</code>:</p>
<div class="fragment"><div class="line">Num rows in matrix: 100</div>
<div class="line">Num ranks: 4</div>
<div class="line">Final Res norm: 5.58392e-12</div>
<div class="line">Iteration count: 7</div>
<div class="line">Init time: 0.0663887</div>
<div class="line">Read time: 0.0729806</div>
<div class="line">Solver generate time: 7.6348e-05</div>
<div class="line">Solver apply time: 0.0680783</div>
<div class="line">Total time: 0.141351</div>
</div><!-- fragment --><p>The timings may vary depending on the machine. <a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/*******************************&lt;GINKGO LICENSE&gt;******************************</span></div>
<div class="line"><span class="comment">Copyright (c) 2017-2023, the Ginkgo authors</span></div>
<div class="line"><span class="comment">All rights reserved.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment">modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment">are met:</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">1. Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment">notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">2. Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment">notice, this list of conditions and the following disclaimer in the</span></div>
<div class="line"><span class="comment">documentation and/or other materials provided with the distribution.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">3. Neither the name of the copyright holder nor the names of its</span></div>
<div class="line"><span class="comment">contributors may be used to endorse or promote products derived from</span></div>
<div class="line"><span class="comment">this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS</span></div>
<div class="line"><span class="comment">IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED</span></div>
<div class="line"><span class="comment">TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A</span></div>
<div class="line"><span class="comment">PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment">HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment">SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment">LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment">DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment">THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment">(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment">OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment">******************************&lt;GINKGO LICENSE&gt;*******************************/</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;ginkgo/ginkgo.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classgko_1_1experimental_1_1mpi_1_1environment.html">gko::experimental::mpi::environment</a> env(argc, argv);</div>
<div class="line">    <span class="keyword">using</span> GlobalIndexType = <a class="code" href="namespacegko.html#a6c57dbf3168b1ecad3ea133aaf2efbc1">gko::int64</a>;</div>
<div class="line">    <span class="keyword">using</span> LocalIndexType = <a class="code" href="namespacegko.html#a1ec26caa2379a21a8d0cde611559fff6">gko::int32</a>;</div>
<div class="line">    <span class="keyword">using</span> ValueType = double;</div>
<div class="line">    <span class="keyword">using</span> dist_vec = <a class="code" href="classgko_1_1experimental_1_1distributed_1_1Vector.html">gko::experimental::distributed::Vector&lt;ValueType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> dist_mtx =</div>
<div class="line">        <a class="code" href="classgko_1_1experimental_1_1distributed_1_1Matrix.html">gko::experimental::distributed::Matrix</a>&lt;ValueType, LocalIndexType,</div>
<div class="line">                                               GlobalIndexType&gt;;</div>
<div class="line">    <span class="keyword">using</span> vec = <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> part_type =</div>
<div class="line">        <a class="code" href="classgko_1_1experimental_1_1distributed_1_1Partition.html">gko::experimental::distributed::Partition</a>&lt;LocalIndexType,</div>
<div class="line">                                                  GlobalIndexType&gt;;</div>
<div class="line">    <span class="keyword">using</span> <a class="code" href="namespacegko_1_1log.html#a15f71654c6c4f4defc95f9359343fa27a7cbf673200498a0d1324f4330825202a">solver</a> = <a class="code" href="classgko_1_1solver_1_1Cg.html">gko::solver::Cg&lt;ValueType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> schwarz = <a class="code" href="classgko_1_1experimental_1_1distributed_1_1preconditioner_1_1Schwarz.html">gko::experimental::distributed::preconditioner::Schwarz</a>&lt;</div>
<div class="line">        ValueType, LocalIndexType, GlobalIndexType&gt;;</div>
<div class="line">    <span class="keyword">using</span> bj = <a class="code" href="classgko_1_1preconditioner_1_1Jacobi.html">gko::preconditioner::Jacobi&lt;ValueType, LocalIndexType&gt;</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> comm = <a class="code" href="classgko_1_1experimental_1_1mpi_1_1communicator.html">gko::experimental::mpi::communicator</a>(MPI_COMM_WORLD);</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> rank = comm.rank();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (argc == 2 &amp;&amp; (std::string(argv[1]) == <span class="stringliteral">&quot;--help&quot;</span>)) {</div>
<div class="line">        <span class="keywordflow">if</span> (rank == 0) {</div>
<div class="line">            std::cerr &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0]</div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot; [executor] [num_grid_points] [num_iterations] &quot;</span></div>
<div class="line">                      &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">        std::exit(-1);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    ValueType t_init = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> executor_string = argc &gt;= 2 ? argv[1] : <span class="stringliteral">&quot;reference&quot;</span>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> grid_dim =</div>
<div class="line">        static_cast&lt;gko::size_type&gt;(argc &gt;= 3 ? std::atoi(argv[2]) : 100);</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> num_iters =</div>
<div class="line">        static_cast&lt;gko::size_type&gt;(argc &gt;= 4 ? std::atoi(argv[3]) : 1000);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::map&lt;std::string,</div>
<div class="line">                   std::function&lt;std::shared_ptr&lt;gko::Executor&gt;(MPI_Comm)&gt;&gt;</div>
<div class="line">        executor_factory_mpi{</div>
<div class="line">            {<span class="stringliteral">&quot;reference&quot;</span>,</div>
<div class="line">             [](MPI_Comm) { <span class="keywordflow">return</span> gko::ReferenceExecutor::create(); }},</div>
<div class="line">            {<span class="stringliteral">&quot;omp&quot;</span>, [](MPI_Comm) { <span class="keywordflow">return</span> <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>(); }},</div>
<div class="line">            {<span class="stringliteral">&quot;cuda&quot;</span>,</div>
<div class="line">             [](MPI_Comm comm) {</div>
<div class="line">                 <span class="keywordtype">int</span> device_id = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a0ec0c93a068b2c19da8cb5e874bf9f6c">gko::experimental::mpi::map_rank_to_device_id</a>(</div>
<div class="line">                     comm, <a class="code" href="classgko_1_1CudaExecutor.html#aef0258494d14de0e56149b920c5173e5">gko::CudaExecutor::get_num_devices</a>());</div>
<div class="line">                 <span class="keywordflow">return</span> <a class="code" href="classgko_1_1CudaExecutor.html#a8e18adb154a44f90c13d61c1e100e160">gko::CudaExecutor::create</a>(</div>
<div class="line">                     device_id, gko::ReferenceExecutor::create(), <span class="keyword">false</span>,</div>
<div class="line">                     gko::allocation_mode::device);</div>
<div class="line">             }},</div>
<div class="line">            {<span class="stringliteral">&quot;hip&quot;</span>,</div>
<div class="line">             [](MPI_Comm comm) {</div>
<div class="line">                 <span class="keywordtype">int</span> device_id = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a0ec0c93a068b2c19da8cb5e874bf9f6c">gko::experimental::mpi::map_rank_to_device_id</a>(</div>
<div class="line">                     comm, <a class="code" href="classgko_1_1HipExecutor.html#a7b34cbd84692dafa2290e6630754aa97">gko::HipExecutor::get_num_devices</a>());</div>
<div class="line">                 <span class="keywordflow">return</span> <a class="code" href="classgko_1_1HipExecutor.html#a5ace87d0179ef0ef55b60e78e9c2f897">gko::HipExecutor::create</a>(</div>
<div class="line">                     device_id, gko::ReferenceExecutor::create(), <span class="keyword">true</span>);</div>
<div class="line">             }},</div>
<div class="line">            {<span class="stringliteral">&quot;dpcpp&quot;</span>, [](MPI_Comm comm) {</div>
<div class="line">                 <span class="keywordtype">int</span> device_id = 0;</div>
<div class="line">                 <span class="keywordflow">if</span> (<a class="code" href="classgko_1_1DpcppExecutor.html#adf306338233c8e8aca0dec96aefe5d93">gko::DpcppExecutor::get_num_devices</a>(<span class="stringliteral">&quot;gpu&quot;</span>)) {</div>
<div class="line">                     device_id = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a0ec0c93a068b2c19da8cb5e874bf9f6c">gko::experimental::mpi::map_rank_to_device_id</a>(</div>
<div class="line">                         comm, <a class="code" href="classgko_1_1DpcppExecutor.html#adf306338233c8e8aca0dec96aefe5d93">gko::DpcppExecutor::get_num_devices</a>(<span class="stringliteral">&quot;gpu&quot;</span>));</div>
<div class="line">                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classgko_1_1DpcppExecutor.html#adf306338233c8e8aca0dec96aefe5d93">gko::DpcppExecutor::get_num_devices</a>(<span class="stringliteral">&quot;cpu&quot;</span>)) {</div>
<div class="line">                     device_id = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a0ec0c93a068b2c19da8cb5e874bf9f6c">gko::experimental::mpi::map_rank_to_device_id</a>(</div>
<div class="line">                         comm, <a class="code" href="classgko_1_1DpcppExecutor.html#adf306338233c8e8aca0dec96aefe5d93">gko::DpcppExecutor::get_num_devices</a>(<span class="stringliteral">&quot;cpu&quot;</span>));</div>
<div class="line">                 } <span class="keywordflow">else</span> {</div>
<div class="line">                     <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;No suitable DPC++ devices&quot;</span>);</div>
<div class="line">                 }</div>
<div class="line">                 <span class="keywordflow">return</span> <a class="code" href="classgko_1_1DpcppExecutor.html#ae9b875dfe3af7f3f3f24071bfb2f895e">gko::DpcppExecutor::create</a>(</div>
<div class="line">                     device_id, gko::ReferenceExecutor::create());</div>
<div class="line">             }}};</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> exec = executor_factory_mpi.at(executor_string)(MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> num_rows = grid_dim;</div>
<div class="line">    <span class="keyword">auto</span> partition = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(part_type::build_from_global_size_uniform(</div>
<div class="line">        exec-&gt;get_master(), comm.size(),</div>
<div class="line">        static_cast&lt;GlobalIndexType&gt;(num_rows)));</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="structgko_1_1matrix__data.html">gko::matrix_data&lt;ValueType, GlobalIndexType&gt;</a> A_data;</div>
<div class="line">    <a class="code" href="structgko_1_1matrix__data.html">gko::matrix_data&lt;ValueType, GlobalIndexType&gt;</a> b_data;</div>
<div class="line">    <a class="code" href="structgko_1_1matrix__data.html">gko::matrix_data&lt;ValueType, GlobalIndexType&gt;</a> x_data;</div>
<div class="line">    A_data.<a class="code" href="structgko_1_1matrix__data.html#a30716bd9e39a7beed52fc56d737fc07b">size</a> = {num_rows, num_rows};</div>
<div class="line">    b_data.<a class="code" href="structgko_1_1matrix__data.html#a30716bd9e39a7beed52fc56d737fc07b">size</a> = {num_rows, 1};</div>
<div class="line">    x_data.<a class="code" href="structgko_1_1matrix__data.html#a30716bd9e39a7beed52fc56d737fc07b">size</a> = {num_rows, 1};</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> range_start = partition-&gt;get_range_bounds()[rank];</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> range_end = partition-&gt;get_range_bounds()[rank + 1];</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = range_start; i &lt; range_end; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (i &gt; 0) {</div>
<div class="line">            A_data.<a class="code" href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">nonzeros</a>.emplace_back(i, i - 1, -1);</div>
<div class="line">        }</div>
<div class="line">        A_data.<a class="code" href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">nonzeros</a>.emplace_back(i, i, 2);</div>
<div class="line">        <span class="keywordflow">if</span> (i &lt; grid_dim - 1) {</div>
<div class="line">            A_data.<a class="code" href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">nonzeros</a>.emplace_back(i, i + 1, -1);</div>
<div class="line">        }</div>
<div class="line">        b_data.<a class="code" href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">nonzeros</a>.emplace_back(i, 0, std::sin(i * 0.01));</div>
<div class="line">        x_data.<a class="code" href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">nonzeros</a>.emplace_back(i, 0, gko::zero&lt;ValueType&gt;());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    comm.synchronize();</div>
<div class="line">    ValueType t_init_end = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> A_host = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(dist_mtx::create(exec-&gt;get_master(), comm));</div>
<div class="line">    <span class="keyword">auto</span> x_host = dist_vec::create(exec-&gt;get_master(), comm);</div>
<div class="line">    <span class="keyword">auto</span> b_host = dist_vec::create(exec-&gt;get_master(), comm);</div>
<div class="line">    A_host-&gt;read_distributed(A_data, partition);</div>
<div class="line">    b_host-&gt;read_distributed(b_data, partition);</div>
<div class="line">    x_host-&gt;read_distributed(x_data, partition);</div>
<div class="line">    <span class="keyword">auto</span> A = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(dist_mtx::create(exec, comm));</div>
<div class="line">    <span class="keyword">auto</span> x = dist_vec::create(exec, comm);</div>
<div class="line">    <span class="keyword">auto</span> b = dist_vec::create(exec, comm);</div>
<div class="line">    A-&gt;copy_from(A_host);</div>
<div class="line">    b-&gt;copy_from(b_host);</div>
<div class="line">    x-&gt;copy_from(x_host);</div>
<div class="line"> </div>
<div class="line">    comm.synchronize();</div>
<div class="line">    ValueType t_read_setup_end = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> local_solver = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(bj::build().on(exec));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="namespacegko.html#afd46d554050c4ae90e84ea4fcd9a41f3">gko::remove_complex&lt;ValueType&gt;</a> reduction_factor{1e-8};</div>
<div class="line">    std::shared_ptr&lt;const gko::log::Convergence&lt;ValueType&gt;&gt; logger =</div>
<div class="line">        <a class="code" href="classgko_1_1log_1_1Convergence.html#abf224a82334775c991f83cfb5e35e18c">gko::log::Convergence&lt;ValueType&gt;::create</a>();</div>
<div class="line">    <span class="keyword">auto</span> iter_stop = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(</div>
<div class="line">        gko::stop::Iteration::build().with_max_iters(num_iters).on(exec));</div>
<div class="line">    <span class="keyword">auto</span> tol_stop = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a>(<a class="code" href="classgko_1_1stop_1_1ResidualNorm.html">gko::stop::ResidualNorm&lt;ValueType&gt;::build</a>()</div>
<div class="line">                                   .with_reduction_factor(reduction_factor)</div>
<div class="line">                                   .on(exec));</div>
<div class="line">    iter_stop-&gt;add_logger(logger);</div>
<div class="line">    tol_stop-&gt;add_logger(logger);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> Ainv =</div>
<div class="line">        solver::build()</div>
<div class="line">            .with_preconditioner(schwarz::build()</div>
<div class="line">                                     .with_local_solver_factory(local_solver)</div>
<div class="line">                                     .on(exec))</div>
<div class="line">            .with_criteria(iter_stop, tol_stop)</div>
<div class="line">            .on(exec)</div>
<div class="line">            -&gt;generate(A);</div>
<div class="line">    Ainv-&gt;add_logger(logger);</div>
<div class="line"> </div>
<div class="line">    comm.synchronize();</div>
<div class="line">    ValueType t_solver_generate_end = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
<div class="line"> </div>
<div class="line">    Ainv-&gt;apply(b, x);</div>
<div class="line"> </div>
<div class="line">    comm.synchronize();</div>
<div class="line">    ValueType t_solver_apply_end = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
<div class="line"> </div>
<div class="line">    x_host-&gt;copy_from(x);</div>
<div class="line">    <span class="keyword">auto</span> <a class="code" href="namespacegko.html#a0059e27f8f4bc348ff65c1e60caf47c8">one</a> = gko::initialize&lt;vec&gt;({1.0}, exec);</div>
<div class="line">    <span class="keyword">auto</span> minus_one = gko::initialize&lt;vec&gt;({-1.0}, exec);</div>
<div class="line">    A_host-&gt;apply(minus_one, x_host, one, b_host);</div>
<div class="line">    <span class="keyword">auto</span> res_norm = gko::initialize&lt;vec&gt;({0.0}, exec-&gt;get_master());</div>
<div class="line">    b_host-&gt;compute_norm2(res_norm);</div>
<div class="line"> </div>
<div class="line">    comm.synchronize();</div>
<div class="line">    ValueType t_end = <a class="code" href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (comm.rank() == 0) {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;\nNum rows in matrix: &quot;</span> &lt;&lt; num_rows</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;\nNum ranks: &quot;</span> &lt;&lt; comm.size()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;\nFinal Res norm: &quot;</span> &lt;&lt; *res_norm-&gt;get_values()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;\nIteration count: &quot;</span> &lt;&lt; logger-&gt;get_num_iterations()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;\nInit time: &quot;</span> &lt;&lt; t_init_end - t_init</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;\nRead time: &quot;</span> &lt;&lt; t_read_setup_end - t_init</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;\nSolver generate time: &quot;</span> &lt;&lt; t_solver_generate_end - t_read_setup_end</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;\nSolver apply time: &quot;</span> &lt;&lt; t_solver_apply_end - t_solver_generate_end</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;\nTotal time: &quot;</span> &lt;&lt; t_end - t_init</div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="astructgko_1_1matrix__data_html_a4f6be92270fa96bccdc502c83d248dc0"><div class="ttname"><a href="structgko_1_1matrix__data.html#a4f6be92270fa96bccdc502c83d248dc0">gko::matrix_data::nonzeros</a></div><div class="ttdeci">std::vector&lt; nonzero_type &gt; nonzeros</div><div class="ttdoc">A vector of tuples storing the non-zeros of the matrix.</div><div class="ttdef"><b>Definition:</b> matrix_data.hpp:482</div></div>
<div class="ttc" id="anamespacegko_1_1log_html_a15f71654c6c4f4defc95f9359343fa27a7cbf673200498a0d1324f4330825202a"><div class="ttname"><a href="namespacegko_1_1log.html#a15f71654c6c4f4defc95f9359343fa27a7cbf673200498a0d1324f4330825202a">gko::log::profile_event_category::solver</a></div><div class="ttdoc">Solver events.</div></div>
<div class="ttc" id="aclassgko_1_1CudaExecutor_html_aef0258494d14de0e56149b920c5173e5"><div class="ttname"><a href="classgko_1_1CudaExecutor.html#aef0258494d14de0e56149b920c5173e5">gko::CudaExecutor::get_num_devices</a></div><div class="ttdeci">static int get_num_devices()</div><div class="ttdoc">Get the number of devices present on the system.</div></div>
<div class="ttc" id="aclassgko_1_1HipExecutor_html_a5ace87d0179ef0ef55b60e78e9c2f897"><div class="ttname"><a href="classgko_1_1HipExecutor.html#a5ace87d0179ef0ef55b60e78e9c2f897">gko::HipExecutor::create</a></div><div class="ttdeci">static std::shared_ptr&lt; HipExecutor &gt; create(int device_id, std::shared_ptr&lt; Executor &gt; master, bool device_reset=false, allocation_mode alloc_mode=default_hip_alloc_mode, CUstream_st *stream=nullptr)</div><div class="ttdoc">Creates a new HipExecutor.</div></div>
<div class="ttc" id="aclassgko_1_1matrix_1_1Dense_html"><div class="ttname"><a href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense</a></div><div class="ttdoc">Dense is a matrix format which explicitly stores all values of the matrix.</div><div class="ttdef"><b>Definition:</b> dense_cache.hpp:48</div></div>
<div class="ttc" id="aclassgko_1_1HipExecutor_html_a7b34cbd84692dafa2290e6630754aa97"><div class="ttname"><a href="classgko_1_1HipExecutor.html#a7b34cbd84692dafa2290e6630754aa97">gko::HipExecutor::get_num_devices</a></div><div class="ttdeci">static int get_num_devices()</div><div class="ttdoc">Get the number of devices present on the system.</div></div>
<div class="ttc" id="aclassgko_1_1experimental_1_1distributed_1_1Matrix_html"><div class="ttname"><a href="classgko_1_1experimental_1_1distributed_1_1Matrix.html">gko::experimental::distributed::Matrix</a></div><div class="ttdoc">The Matrix class defines a (MPI-)distributed matrix.</div><div class="ttdef"><b>Definition:</b> matrix.hpp:264</div></div>
<div class="ttc" id="aclassgko_1_1experimental_1_1distributed_1_1Vector_html"><div class="ttname"><a href="classgko_1_1experimental_1_1distributed_1_1Vector.html">gko::experimental::distributed::Vector</a></div><div class="ttdoc">Vector is a format which explicitly stores (multiple) distributed column vectors in a dense storage f...</div><div class="ttdef"><b>Definition:</b> matrix.hpp:155</div></div>
<div class="ttc" id="aclassgko_1_1experimental_1_1mpi_1_1environment_html"><div class="ttname"><a href="classgko_1_1experimental_1_1mpi_1_1environment.html">gko::experimental::mpi::environment</a></div><div class="ttdoc">Class that sets up and finalizes the MPI environment.</div><div class="ttdef"><b>Definition:</b> mpi.hpp:226</div></div>
<div class="ttc" id="aclassgko_1_1DpcppExecutor_html_adf306338233c8e8aca0dec96aefe5d93"><div class="ttname"><a href="classgko_1_1DpcppExecutor.html#adf306338233c8e8aca0dec96aefe5d93">gko::DpcppExecutor::get_num_devices</a></div><div class="ttdeci">static int get_num_devices(std::string device_type)</div><div class="ttdoc">Get the number of devices present on the system.</div></div>
<div class="ttc" id="aclassgko_1_1OmpExecutor_html_a33ca05fdd0fc928ee262fc9425304874"><div class="ttname"><a href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a></div><div class="ttdeci">static std::shared_ptr&lt; OmpExecutor &gt; create()</div><div class="ttdoc">Creates a new OmpExecutor.</div><div class="ttdef"><b>Definition:</b> executor.hpp:1407</div></div>
<div class="ttc" id="aclassgko_1_1preconditioner_1_1Jacobi_html"><div class="ttname"><a href="classgko_1_1preconditioner_1_1Jacobi.html">gko::preconditioner::Jacobi</a></div><div class="ttdoc">A block-Jacobi preconditioner is a block-diagonal linear operator, obtained by inverting the diagonal...</div><div class="ttdef"><b>Definition:</b> jacobi.hpp:213</div></div>
<div class="ttc" id="aclassgko_1_1stop_1_1ResidualNorm_html"><div class="ttname"><a href="classgko_1_1stop_1_1ResidualNorm.html">gko::stop::ResidualNorm</a></div><div class="ttdoc">The ResidualNorm class is a stopping criterion which stops the iteration process when the actual resi...</div><div class="ttdef"><b>Definition:</b> residual_norm.hpp:137</div></div>
<div class="ttc" id="aclassgko_1_1experimental_1_1mpi_1_1communicator_html"><div class="ttname"><a href="classgko_1_1experimental_1_1mpi_1_1communicator.html">gko::experimental::mpi::communicator</a></div><div class="ttdoc">A thin wrapper of MPI_Comm that supports most MPI calls.</div><div class="ttdef"><b>Definition:</b> mpi.hpp:436</div></div>
<div class="ttc" id="astructgko_1_1matrix__data_html"><div class="ttname"><a href="structgko_1_1matrix__data.html">gko::matrix_data</a></div><div class="ttdoc">This structure is used as an intermediate data type to store a sparse matrix.</div><div class="ttdef"><b>Definition:</b> matrix_data.hpp:155</div></div>
<div class="ttc" id="astructgko_1_1matrix__data_html_a30716bd9e39a7beed52fc56d737fc07b"><div class="ttname"><a href="structgko_1_1matrix__data.html#a30716bd9e39a7beed52fc56d737fc07b">gko::matrix_data::size</a></div><div class="ttdeci">dim&lt; 2 &gt; size</div><div class="ttdoc">Size of the matrix.</div><div class="ttdef"><b>Definition:</b> matrix_data.hpp:473</div></div>
<div class="ttc" id="aclassgko_1_1solver_1_1Cg_html"><div class="ttname"><a href="classgko_1_1solver_1_1Cg.html">gko::solver::Cg</a></div><div class="ttdoc">CG or the conjugate gradient method is an iterative type Krylov subspace method which is suitable for...</div><div class="ttdef"><b>Definition:</b> cg.hpp:74</div></div>
<div class="ttc" id="anamespacegko_html_a3ce296f73db0ff398bdea6009a3a5c58"><div class="ttname"><a href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a></div><div class="ttdeci">detail::shared_type&lt; OwningPointer &gt; share(OwningPointer &amp;&amp;p)</div><div class="ttdoc">Marks the object pointed to by p as shared.</div><div class="ttdef"><b>Definition:</b> utils_helper.hpp:254</div></div>
<div class="ttc" id="anamespacegko_1_1experimental_1_1mpi_html_a0ec0c93a068b2c19da8cb5e874bf9f6c"><div class="ttname"><a href="namespacegko_1_1experimental_1_1mpi.html#a0ec0c93a068b2c19da8cb5e874bf9f6c">gko::experimental::mpi::map_rank_to_device_id</a></div><div class="ttdeci">int map_rank_to_device_id(MPI_Comm comm, int num_devices)</div><div class="ttdoc">Maps each MPI rank to a single device id in a round robin manner.</div></div>
<div class="ttc" id="anamespacegko_1_1experimental_1_1mpi_html_a508f97387781bb32dd2c7616dee1a786"><div class="ttname"><a href="namespacegko_1_1experimental_1_1mpi.html#a508f97387781bb32dd2c7616dee1a786">gko::experimental::mpi::get_walltime</a></div><div class="ttdeci">double get_walltime()</div><div class="ttdoc">Get the rank in the communicator of the calling process.</div><div class="ttdef"><b>Definition:</b> mpi.hpp:1522</div></div>
<div class="ttc" id="aclassgko_1_1log_1_1Convergence_html_abf224a82334775c991f83cfb5e35e18c"><div class="ttname"><a href="classgko_1_1log_1_1Convergence.html#abf224a82334775c991f83cfb5e35e18c">gko::log::Convergence::create</a></div><div class="ttdeci">static std::unique_ptr&lt; Convergence &gt; create(std::shared_ptr&lt; const Executor &gt;, const mask_type &amp;enabled_events=Logger::all_events_mask)</div><div class="ttdoc">Creates a convergence logger.</div><div class="ttdef"><b>Definition:</b> convergence.hpp:99</div></div>
<div class="ttc" id="aclassgko_1_1experimental_1_1distributed_1_1Partition_html"><div class="ttname"><a href="classgko_1_1experimental_1_1distributed_1_1Partition.html">gko::experimental::distributed::Partition</a></div><div class="ttdoc">Represents a partition of a range of indices [0, size) into a disjoint set of parts.</div><div class="ttdef"><b>Definition:</b> matrix.hpp:153</div></div>
<div class="ttc" id="anamespacegko_html_a6c57dbf3168b1ecad3ea133aaf2efbc1"><div class="ttname"><a href="namespacegko.html#a6c57dbf3168b1ecad3ea133aaf2efbc1">gko::int64</a></div><div class="ttdeci">std::int64_t int64</div><div class="ttdoc">64-bit signed integral type.</div><div class="ttdef"><b>Definition:</b> types.hpp:128</div></div>
<div class="ttc" id="anamespacegko_html_a1ec26caa2379a21a8d0cde611559fff6"><div class="ttname"><a href="namespacegko.html#a1ec26caa2379a21a8d0cde611559fff6">gko::int32</a></div><div class="ttdeci">std::int32_t int32</div><div class="ttdoc">32-bit signed integral type.</div><div class="ttdef"><b>Definition:</b> types.hpp:122</div></div>
<div class="ttc" id="anamespacegko_html_afd46d554050c4ae90e84ea4fcd9a41f3"><div class="ttname"><a href="namespacegko.html#afd46d554050c4ae90e84ea4fcd9a41f3">gko::remove_complex</a></div><div class="ttdeci">typename detail::remove_complex_s&lt; T &gt;::type remove_complex</div><div class="ttdoc">Obtain the type which removed the complex of complex/scalar type or the template parameter of class b...</div><div class="ttdef"><b>Definition:</b> math.hpp:361</div></div>
<div class="ttc" id="aclassgko_1_1DpcppExecutor_html_ae9b875dfe3af7f3f3f24071bfb2f895e"><div class="ttname"><a href="classgko_1_1DpcppExecutor.html#ae9b875dfe3af7f3f3f24071bfb2f895e">gko::DpcppExecutor::create</a></div><div class="ttdeci">static std::shared_ptr&lt; DpcppExecutor &gt; create(int device_id, std::shared_ptr&lt; Executor &gt; master, std::string device_type=&quot;all&quot;, dpcpp_queue_property property=dpcpp_queue_property::in_order)</div><div class="ttdoc">Creates a new DpcppExecutor.</div></div>
<div class="ttc" id="aclassgko_1_1experimental_1_1distributed_1_1preconditioner_1_1Schwarz_html"><div class="ttname"><a href="classgko_1_1experimental_1_1distributed_1_1preconditioner_1_1Schwarz.html">gko::experimental::distributed::preconditioner::Schwarz</a></div><div class="ttdoc">A Schwarz preconditioner is a simple domain decomposition preconditioner that generalizes the Block J...</div><div class="ttdef"><b>Definition:</b> schwarz.hpp:78</div></div>
<div class="ttc" id="aclassgko_1_1CudaExecutor_html_a8e18adb154a44f90c13d61c1e100e160"><div class="ttname"><a href="classgko_1_1CudaExecutor.html#a8e18adb154a44f90c13d61c1e100e160">gko::CudaExecutor::create</a></div><div class="ttdeci">static std::shared_ptr&lt; CudaExecutor &gt; create(int device_id, std::shared_ptr&lt; Executor &gt; master, bool device_reset=false, allocation_mode alloc_mode=default_cuda_alloc_mode, CUstream_st *stream=nullptr)</div><div class="ttdoc">Creates a new CudaExecutor.</div></div>
<div class="ttc" id="anamespacegko_html_a0059e27f8f4bc348ff65c1e60caf47c8"><div class="ttname"><a href="namespacegko.html#a0059e27f8f4bc348ff65c1e60caf47c8">gko::one</a></div><div class="ttdeci">constexpr T one()</div><div class="ttdoc">Returns the multiplicative identity for T.</div><div class="ttdef"><b>Definition:</b> math.hpp:810</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>

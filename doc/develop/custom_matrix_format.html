<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ginkgo: The custom-matrix-format program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_doc.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Ginkgo
   &#160;<span id="projectnumber">Generated from pipelines/531654193 branch based on develop. Ginkgo version 1.5.0</span>
   </div>
   <div id="projectbrief">A numerical linear algebra library targeting many-core architectures</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The custom-matrix-format program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The custom matrix format example..</p>
<p>This example depends on simple-solver, poisson-solver, three-pt-stencil-solver, .</p>
<p> 
<table class="example" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Abouttheexample"> About the example </a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Commentsaboutprogramminganddebugging"> Comments about programming and debugging </a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>This example solves a 1D Poisson equation:</p>
<p><img class="formulaInl" alt="$ u : [0, 1] \rightarrow R\\ u'' = f\\ u(0) = u0\\ u(1) = u1 $" src="form_57.png"/></p>
<p>using a finite difference method on an equidistant grid with <code>K</code> discretization points (<code>K</code> can be controlled with a command line parameter). The discretization is done via the second order Taylor polynomial:</p>
<p><img class="formulaInl" alt="$ u(x + h) = u(x) - u'(x)h + 1/2 u''(x)h^2 + O(h^3)\\ u(x - h) = u(x) + u'(x)h + 1/2 u''(x)h^2 + O(h^3) / +\\ ---------------------- \\ -u(x - h) + 2u(x) + -u(x + h) = -f(x)h^2 + O(h^3) $" src="form_58.png"/></p>
<p>For an equidistant grid with K "inner" discretization points <img class="formulaInl" alt="$x1, ..., xk, $" src="form_59.png"/>and step size <img class="formulaInl" alt="$ h = 1 / (K + 1)$" src="form_60.png"/>, the formula produces a system of linear equations</p>
<p><img class="formulaInl" alt="$ 2u_1 - u_2 = -f_1 h^2 + u0\\ -u_(k-1) + 2u_k - u_(k+1) = -f_k h^2, k = 2, ..., K - 1\\ -u_(K-1) + 2u_K = -f_K h^2 + u1\\ $" src="form_61.png"/></p>
<p>which is then solved using Ginkgo's implementation of the CG method preconditioned with block-Jacobi. It is also possible to specify on which executor Ginkgo will solve the system via the command line. The function <img class="formulaInl" alt="$`f` $" src="form_62.png"/>is set to <img class="formulaInl" alt="$`f(x) = 6x`$" src="form_63.png"/> (making the solution <img class="formulaInl" alt="$`u(x) = x^3`$" src="form_64.png"/>), but that can be changed in the <code>main</code> function.</p>
<p>The intention of this example is to show how a custom linear operator can be created and integrated into Ginkgo to achieve performance benefits.</p>
<p><a class="anchor" id="Abouttheexample"></a></p><h3>About the example </h3>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;omp.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;ginkgo/ginkgo.hpp&gt;</span></div>
</div><!-- fragment --><p>A CUDA kernel implementing the stencil, which will be used if running on the CUDA executor. Unfortunately, NVCC has serious problems interpreting some parts of Ginkgo's code, so the kernel has to be compiled separately.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">void</span> stencil_kernel(std::size_t size, <span class="keyword">const</span> ValueType* coefs,</div>
<div class="line">                    <span class="keyword">const</span> ValueType* b, ValueType* x);</div>
</div><!-- fragment --><p>A stencil matrix class representing the 3pt stencil linear operator. We include the <a class="el" href="classgko_1_1EnableLinOp.html" title="The EnableLinOp mixin can be used to provide sensible default implementations of the majority of the ...">gko::EnableLinOp</a> mixin which implements the entire LinOp interface, except the two apply_impl methods, which get called inside the default implementation of apply (after argument verification) to perform the actual application of the linear operator. In addition, it includes the implementation of the entire PolymorphicObject interface.</p>
<p>It also includes the <a class="el" href="classgko_1_1EnableCreateMethod.html" title="This mixin implements a static create() method on ConcreteType that dynamically allocates the memory,...">gko::EnableCreateMethod</a> mixin which provides a default implementation of the static create method. This method will forward all its arguments to the constructor to create the object, and return an std::unique_ptr to the created object.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keyword">class </span>StencilMatrix : <span class="keyword">public</span> <a class="code" href="classgko_1_1EnableLinOp.html">gko::EnableLinOp</a>&lt;StencilMatrix&lt;ValueType&gt;&gt;,</div>
<div class="line">                      <span class="keyword">public</span> <a class="code" href="classgko_1_1EnableCreateMethod.html">gko::EnableCreateMethod</a>&lt;StencilMatrix&lt;ValueType&gt;&gt; {</div>
<div class="line"><span class="keyword">public</span>:</div>
</div><!-- fragment --><p>This constructor will be called by the create method. Here we initialize the coefficients of the stencil.</p>
<div class="fragment"><div class="line">    StencilMatrix(std::shared_ptr&lt;const gko::Executor&gt; exec,</div>
<div class="line">                  <a class="code" href="namespacegko.html#a6e5c95df0ae4e47aab2f604a22d98ee7">gko::size_type</a> size = 0, ValueType left = -1.0,</div>
<div class="line">                  ValueType center = 2.0, ValueType right = -1.0)</div>
<div class="line">        : <a class="code" href="namespacegko.html">gko</a>::EnableLinOp&lt;StencilMatrix&gt;(exec, <a class="code" href="namespacegko.html">gko</a>::dim&lt;2&gt;{size}),</div>
<div class="line">          coefficients(exec, {left, center, right})</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">    <span class="keyword">using</span> vec = <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> coef_type = <a class="code" href="classgko_1_1array.html">gko::array&lt;ValueType&gt;</a>;</div>
</div><!-- fragment --><p>Here we implement the application of the linear operator, x = A * b. apply_impl will be called by the apply method, after the arguments have been moved to the correct executor and the operators checked for conforming sizes.</p>
<p>For simplicity, we assume that there is always only one right hand side and the stride of consecutive elements in the vectors is 1 (both of these are always true in this example).</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> apply_impl(<span class="keyword">const</span> <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* b, <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* x)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword"></span>{</div>
</div><!-- fragment --><p>we only implement the operator for dense RHS. <a class="el" href="namespacegko.html#a73ce7e87aec389b5210630bb617b4baa" title="Performs polymorphic type conversion.">gko::as</a> will throw an exception if its argument is not Dense.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> dense_b = gko::as&lt;vec&gt;(b);</div>
<div class="line"><span class="keyword">auto</span> dense_x = gko::as&lt;vec&gt;(x);</div>
</div><!-- fragment --><p>we need separate implementations depending on the executor, so we create an operation which maps the call to the correct implementation</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>stencil_operation : <a class="code" href="classgko_1_1Operation.html">gko::Operation</a> {</div>
<div class="line">    stencil_operation(<span class="keyword">const</span> coef_type&amp; coefficients, <span class="keyword">const</span> vec* b,</div>
<div class="line">                      vec* x)</div>
<div class="line">        : coefficients{coefficients}, b{b}, x{x}</div>
<div class="line">    {}</div>
</div><!-- fragment --><p>OpenMP implementation</p>
<div class="fragment"><div class="line">            <span class="keywordtype">void</span> run(std::shared_ptr&lt;const gko::OmpExecutor&gt;)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">            </span>{</div>
<div class="line">                <span class="keyword">auto</span> b_values = b-&gt;get_const_values();</div>
<div class="line">                <span class="keyword">auto</span> x_values = x-&gt;get_values();</div>
<div class="line"><span class="preprocessor">#pragma omp parallel for</span></div>
<div class="line">                <span class="keywordflow">for</span> (std::size_t i = 0; i &lt; x-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0]; ++i) {</div>
<div class="line">                    <span class="keyword">auto</span> coefs = coefficients.get_const_data();</div>
<div class="line">                    <span class="keyword">auto</span> result = coefs[1] * b_values[i];</div>
<div class="line">                    <span class="keywordflow">if</span> (i &gt; 0) {</div>
<div class="line">                        result += coefs[0] * b_values[i - 1];</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">if</span> (i &lt; x-&gt;get_size()[0] - 1) {</div>
<div class="line">                        result += coefs[2] * b_values[i + 1];</div>
<div class="line">                    }</div>
<div class="line">                    x_values[i] = result;</div>
<div class="line">                }</div>
<div class="line">            }</div>
</div><!-- fragment --><p>CUDA implementation</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> run(std::shared_ptr&lt;const gko::CudaExecutor&gt;)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    stencil_kernel(x-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0], coefficients.get_const_data(),</div>
<div class="line">                   b-&gt;get_const_values(), x-&gt;get_values());</div>
<div class="line">}</div>
</div><!-- fragment --><p>We do not provide an implementation for reference executor. If not provided, Ginkgo will use the implementation for the OpenMP executor when calling it in the reference executor.</p>
<div class="fragment"><div class="line">        <span class="keyword">const</span> coef_type&amp; coefficients;</div>
<div class="line">        <span class="keyword">const</span> vec* b;</div>
<div class="line">        vec* x;</div>
<div class="line">    };</div>
<div class="line">    this-&gt;get_executor()-&gt;run(</div>
<div class="line">        stencil_operation(coefficients, dense_b, dense_x));</div>
<div class="line">}</div>
</div><!-- fragment --><p>There is also a version of the apply function which does the operation x = alpha * A * b + beta * x. This function is commonly used and can often be better optimized than implementing it using x = A * b. However, for simplicity, we will implement it exactly like that in this example.</p>
<div class="fragment"><div class="line">    <span class="keywordtype">void</span> apply_impl(<span class="keyword">const</span> <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* alpha, <span class="keyword">const</span> <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* b,</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* beta, <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* x)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">auto</span> dense_b = gko::as&lt;vec&gt;(b);</div>
<div class="line">        <span class="keyword">auto</span> dense_x = gko::as&lt;vec&gt;(x);</div>
<div class="line">        <span class="keyword">auto</span> tmp_x = dense_x-&gt;clone();</div>
<div class="line">        this-&gt;apply_impl(b, <a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(tmp_x));</div>
<div class="line">        dense_x-&gt;scale(beta);</div>
<div class="line">        dense_x-&gt;add_scaled(alpha, <a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(tmp_x));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    coef_type coefficients;</div>
<div class="line">};</div>
</div><!-- fragment --><p>Creates a stencil matrix in CSR format for the given number of discretization points.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType, <span class="keyword">typename</span> IndexType&gt;</div>
<div class="line"><span class="keywordtype">void</span> generate_stencil_matrix(<a class="code" href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr&lt;ValueType, IndexType&gt;</a>* matrix)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> discretization_points = matrix-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0];</div>
<div class="line">    <span class="keyword">auto</span> row_ptrs = matrix-&gt;<a class="code" href="classgko_1_1matrix_1_1Csr.html#a068e5158cf282fa977f0a137f8cd7f03">get_row_ptrs</a>();</div>
<div class="line">    <span class="keyword">auto</span> col_idxs = matrix-&gt;<a class="code" href="classgko_1_1matrix_1_1Csr.html#a81c6294177a1be4873804c8a85a9fc64">get_col_idxs</a>();</div>
<div class="line">    <span class="keyword">auto</span> values = matrix-&gt;<a class="code" href="classgko_1_1matrix_1_1Csr.html#a929b0a194e6aeb1252b8e6781d162e83">get_values</a>();</div>
<div class="line">    IndexType pos = 0;</div>
<div class="line">    <span class="keyword">const</span> ValueType coefs[] = {-1, 2, -1};</div>
<div class="line">    row_ptrs[0] = pos;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; discretization_points; ++i) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> ofs : {-1, 0, 1}) {</div>
<div class="line">            <span class="keywordflow">if</span> (0 &lt;= i + ofs &amp;&amp; i + ofs &lt; discretization_points) {</div>
<div class="line">                values[pos] = coefs[ofs + 1];</div>
<div class="line">                col_idxs[pos] = i + ofs;</div>
<div class="line">                ++pos;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        row_ptrs[i + 1] = pos;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Generates the RHS vector given <code>f</code> and the boundary conditions.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Closure, <span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">void</span> generate_rhs(Closure f, ValueType u0, ValueType u1,</div>
<div class="line">                  <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>* rhs)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> discretization_points = rhs-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0];</div>
<div class="line">    <span class="keyword">auto</span> values = rhs-&gt;<a class="code" href="classgko_1_1matrix_1_1Dense.html#a3bc458e02fab8e4c9f60f70bd4d5a4f9">get_values</a>();</div>
<div class="line">    <span class="keyword">const</span> ValueType h = 1.0 / (discretization_points + 1);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; discretization_points; ++i) {</div>
<div class="line">        <span class="keyword">const</span> ValueType xi = ValueType(i + 1) * h;</div>
<div class="line">        values[i] = -f(xi) * h * h;</div>
<div class="line">    }</div>
<div class="line">    values[0] += u0;</div>
<div class="line">    values[discretization_points - 1] += u1;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Prints the solution <code>u</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">void</span> print_solution(ValueType u0, ValueType u1,</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>* u)</div>
<div class="line">{</div>
<div class="line">    std::cout &lt;&lt; u0 &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; u-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0]; ++i) {</div>
<div class="line">        std::cout &lt;&lt; u-&gt;<a class="code" href="classgko_1_1matrix_1_1Dense.html#ab83c739c1b11abaecc3bfd89506f6c9c">get_const_values</a>()[i] &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">    }</div>
<div class="line">    std::cout &lt;&lt; u1 &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Computes the 1-norm of the error given the computed <code>u</code> and the correct solution function <code>correct_u</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Closure, <span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">double</span> calculate_error(<span class="keywordtype">int</span> discretization_points,</div>
<div class="line">                       <span class="keyword">const</span> <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>* u,</div>
<div class="line">                       Closure correct_u)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> h = 1.0 / (discretization_points + 1);</div>
<div class="line">    <span class="keyword">auto</span> error = 0.0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; discretization_points; ++i) {</div>
<div class="line">        <span class="keyword">using</span> std::abs;</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> xi = (i + 1) * h;</div>
<div class="line">        error +=</div>
<div class="line">            <a class="code" href="namespacegko.html#adeb470aaf293d7c5548392b2f451e8e4">abs</a>(u-&gt;<a class="code" href="classgko_1_1matrix_1_1Dense.html#ab83c739c1b11abaecc3bfd89506f6c9c">get_const_values</a>()[i] - correct_u(xi)) / <a class="code" href="namespacegko.html#adeb470aaf293d7c5548392b2f451e8e4">abs</a>(correct_u(xi));</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> error;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
</div><!-- fragment --><p>Some shortcuts</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> ValueType = double;</div>
<div class="line"><span class="keyword">using</span> RealValueType = <a class="code" href="namespacegko.html#afd46d554050c4ae90e84ea4fcd9a41f3">gko::remove_complex&lt;ValueType&gt;</a>;</div>
<div class="line"><span class="keyword">using</span> IndexType = int;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using</span> vec = <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>;</div>
<div class="line"><span class="keyword">using</span> mtx = <a class="code" href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr&lt;ValueType, IndexType&gt;</a>;</div>
<div class="line"><span class="keyword">using</span> cg = <a class="code" href="classgko_1_1solver_1_1Cg.html">gko::solver::Cg&lt;ValueType&gt;</a>;</div>
</div><!-- fragment --><p>Figure out where to run the code</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (argc == 2 &amp;&amp; (std::string(argv[1]) == <span class="stringliteral">&quot;--help&quot;</span>)) {</div>
<div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">&quot; [executor]&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    std::exit(-1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> executor_string = argc &gt;= 2 ? argv[1] : <span class="stringliteral">&quot;reference&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> discretization_points =</div>
<div class="line">    argc &gt;= 3 ? std::atoi(argv[2]) : 100u;</div>
<div class="line">std::map&lt;std::string, std::function&lt;std::shared_ptr&lt;gko::Executor&gt;()&gt;&gt;</div>
<div class="line">    exec_map{</div>
<div class="line">        {<span class="stringliteral">&quot;omp&quot;</span>, [] { <span class="keywordflow">return</span> <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>(); }},</div>
<div class="line">        {<span class="stringliteral">&quot;cuda&quot;</span>,</div>
<div class="line">         [] {</div>
<div class="line">             <span class="keywordflow">return</span> <a class="code" href="classgko_1_1CudaExecutor.html#a5dcec3ca1c458382e01191b727959a81">gko::CudaExecutor::create</a>(0, <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>(),</div>
<div class="line">                                              <span class="keyword">true</span>);</div>
<div class="line">         }},</div>
<div class="line">        {<span class="stringliteral">&quot;hip&quot;</span>,</div>
<div class="line">         [] {</div>
<div class="line">             <span class="keywordflow">return</span> <a class="code" href="classgko_1_1HipExecutor.html#ad3a72bc42254fb8730bc2090147447d9">gko::HipExecutor::create</a>(0, <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>(),</div>
<div class="line">                                             <span class="keyword">true</span>);</div>
<div class="line">         }},</div>
<div class="line">        {<span class="stringliteral">&quot;dpcpp&quot;</span>,</div>
<div class="line">         [] {</div>
<div class="line">             <span class="keywordflow">return</span> <a class="code" href="classgko_1_1DpcppExecutor.html#ac46044fcb00b2d224b45d93eaf8c579d">gko::DpcppExecutor::create</a>(0,</div>
<div class="line">                                               <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>());</div>
<div class="line">         }},</div>
<div class="line">        {<span class="stringliteral">&quot;reference&quot;</span>, [] { <span class="keywordflow">return</span> gko::ReferenceExecutor::create(); }}};</div>
</div><!-- fragment --><p>executor where Ginkgo will perform the computation</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> exec = exec_map.at(executor_string)();  <span class="comment">// throws if not valid</span></div>
</div><!-- fragment --><p>executor used by the application</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> app_exec = exec-&gt;get_master();</div>
</div><!-- fragment --><p>problem:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> correct_u = [](ValueType x) { <span class="keywordflow">return</span> x * x * x; };</div>
<div class="line"><span class="keyword">auto</span> f = [](ValueType x) { <span class="keywordflow">return</span> ValueType{6} * x; };</div>
<div class="line"><span class="keyword">auto</span> u0 = correct_u(0);</div>
<div class="line"><span class="keyword">auto</span> u1 = correct_u(1);</div>
</div><!-- fragment --><p>initialize vectors</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> rhs = vec::create(app_exec, <a class="code" href="structgko_1_1dim.html">gko::dim&lt;2&gt;</a>(discretization_points, 1));</div>
<div class="line">generate_rhs(f, u0, u1, <a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(rhs));</div>
<div class="line"><span class="keyword">auto</span> u = vec::create(app_exec, <a class="code" href="structgko_1_1dim.html">gko::dim&lt;2&gt;</a>(discretization_points, 1));</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; u-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0]; ++i) {</div>
<div class="line">    u-&gt;<a class="code" href="classgko_1_1matrix_1_1Dense.html#a3bc458e02fab8e4c9f60f70bd4d5a4f9">get_values</a>()[i] = 0.0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> RealValueType reduction_factor{1e-7};</div>
</div><!-- fragment --><p>Generate solver and solve the system</p>
<div class="fragment"><div class="line">cg::build()</div>
<div class="line">    .with_criteria(gko::stop::Iteration::build()</div>
<div class="line">                       .with_max_iters(discretization_points)</div>
<div class="line">                       .on(exec),</div>
<div class="line">                   <a class="code" href="classgko_1_1stop_1_1ResidualNorm.html">gko::stop::ResidualNorm&lt;ValueType&gt;::build</a>()</div>
<div class="line">                       .with_reduction_factor(reduction_factor)</div>
<div class="line">                       .on(exec))</div>
<div class="line">    .on(exec)</div>
</div><!-- fragment --><p>notice how our custom StencilMatrix can be used in the same way as any built-in type</p>
<div class="fragment"><div class="line">        -&gt;generate(StencilMatrix&lt;ValueType&gt;::create(exec, discretization_points,</div>
<div class="line">                                                    -1, 2, -1))</div>
<div class="line">        -&gt;apply(<a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(rhs), <a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(u));</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;\nSolve complete.&quot;</span></div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;\nThe average relative error is &quot;</span></div>
<div class="line">              &lt;&lt; calculate_error(discretization_points, <a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(u), correct_u) /</div>
<div class="line">                     discretization_points</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p><a class="anchor" id="Commentsaboutprogramminganddebugging"></a></p><h3>Comments about programming and debugging </h3>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/*******************************&lt;GINKGO LICENSE&gt;******************************</span></div>
<div class="line"><span class="comment">Copyright (c) 2017-2022, the Ginkgo authors</span></div>
<div class="line"><span class="comment">All rights reserved.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment">modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment">are met:</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">1. Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment">notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">2. Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment">notice, this list of conditions and the following disclaimer in the</span></div>
<div class="line"><span class="comment">documentation and/or other materials provided with the distribution.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">3. Neither the name of the copyright holder nor the names of its</span></div>
<div class="line"><span class="comment">contributors may be used to endorse or promote products derived from</span></div>
<div class="line"><span class="comment">this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS</span></div>
<div class="line"><span class="comment">IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED</span></div>
<div class="line"><span class="comment">TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A</span></div>
<div class="line"><span class="comment">PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment">HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment">SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment">LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment">DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment">THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment">(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment">OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment">******************************&lt;GINKGO LICENSE&gt;*******************************/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;omp.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;ginkgo/ginkgo.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">void</span> stencil_kernel(std::size_t size, <span class="keyword">const</span> ValueType* coefs,</div>
<div class="line">                    <span class="keyword">const</span> ValueType* b, ValueType* x);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keyword">class </span>StencilMatrix : <span class="keyword">public</span> <a class="code" href="classgko_1_1EnableLinOp.html">gko::EnableLinOp</a>&lt;StencilMatrix&lt;ValueType&gt;&gt;,</div>
<div class="line">                      <span class="keyword">public</span> <a class="code" href="classgko_1_1EnableCreateMethod.html">gko::EnableCreateMethod</a>&lt;StencilMatrix&lt;ValueType&gt;&gt; {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    StencilMatrix(std::shared_ptr&lt;const gko::Executor&gt; exec,</div>
<div class="line">                  <a class="code" href="namespacegko.html#a6e5c95df0ae4e47aab2f604a22d98ee7">gko::size_type</a> size = 0, ValueType left = -1.0,</div>
<div class="line">                  ValueType center = 2.0, ValueType right = -1.0)</div>
<div class="line">        : <a class="code" href="namespacegko.html">gko</a>::EnableLinOp&lt;StencilMatrix&gt;(exec, <a class="code" href="namespacegko.html">gko</a>::dim&lt;2&gt;{size}),</div>
<div class="line">          coefficients(exec, {left, center, right})</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">    <span class="keyword">using</span> vec = <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> coef_type = <a class="code" href="classgko_1_1array.html">gko::array&lt;ValueType&gt;</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> apply_impl(<span class="keyword">const</span> <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* b, <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* x)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">auto</span> dense_b = gko::as&lt;vec&gt;(b);</div>
<div class="line">        <span class="keyword">auto</span> dense_x = gko::as&lt;vec&gt;(x);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">struct </span>stencil_operation : <a class="code" href="classgko_1_1Operation.html">gko::Operation</a> {</div>
<div class="line">            stencil_operation(<span class="keyword">const</span> coef_type&amp; coefficients, <span class="keyword">const</span> vec* b,</div>
<div class="line">                              vec* x)</div>
<div class="line">                : coefficients{coefficients}, b{b}, x{x}</div>
<div class="line">            {}</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">void</span> run(std::shared_ptr&lt;const gko::OmpExecutor&gt;)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">            </span>{</div>
<div class="line">                <span class="keyword">auto</span> b_values = b-&gt;get_const_values();</div>
<div class="line">                <span class="keyword">auto</span> x_values = x-&gt;get_values();</div>
<div class="line"><span class="preprocessor">#pragma omp parallel for</span></div>
<div class="line">                <span class="keywordflow">for</span> (std::size_t i = 0; i &lt; x-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0]; ++i) {</div>
<div class="line">                    <span class="keyword">auto</span> coefs = coefficients.get_const_data();</div>
<div class="line">                    <span class="keyword">auto</span> result = coefs[1] * b_values[i];</div>
<div class="line">                    <span class="keywordflow">if</span> (i &gt; 0) {</div>
<div class="line">                        result += coefs[0] * b_values[i - 1];</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">if</span> (i &lt; x-&gt;get_size()[0] - 1) {</div>
<div class="line">                        result += coefs[2] * b_values[i + 1];</div>
<div class="line">                    }</div>
<div class="line">                    x_values[i] = result;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">void</span> run(std::shared_ptr&lt;const gko::CudaExecutor&gt;)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">            </span>{</div>
<div class="line">                stencil_kernel(x-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0], coefficients.get_const_data(),</div>
<div class="line">                               b-&gt;get_const_values(), x-&gt;get_values());</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> coef_type&amp; coefficients;</div>
<div class="line">            <span class="keyword">const</span> vec* b;</div>
<div class="line">            vec* x;</div>
<div class="line">        };</div>
<div class="line">        this-&gt;get_executor()-&gt;run(</div>
<div class="line">            stencil_operation(coefficients, dense_b, dense_x));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> apply_impl(<span class="keyword">const</span> <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* alpha, <span class="keyword">const</span> <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* b,</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* beta, <a class="code" href="classgko_1_1LinOp.html">gko::LinOp</a>* x)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">auto</span> dense_b = gko::as&lt;vec&gt;(b);</div>
<div class="line">        <span class="keyword">auto</span> dense_x = gko::as&lt;vec&gt;(x);</div>
<div class="line">        <span class="keyword">auto</span> tmp_x = dense_x-&gt;clone();</div>
<div class="line">        this-&gt;apply_impl(b, <a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(tmp_x));</div>
<div class="line">        dense_x-&gt;scale(beta);</div>
<div class="line">        dense_x-&gt;add_scaled(alpha, <a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(tmp_x));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    coef_type coefficients;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType, <span class="keyword">typename</span> IndexType&gt;</div>
<div class="line"><span class="keywordtype">void</span> generate_stencil_matrix(<a class="code" href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr&lt;ValueType, IndexType&gt;</a>* matrix)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> discretization_points = matrix-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0];</div>
<div class="line">    <span class="keyword">auto</span> row_ptrs = matrix-&gt;<a class="code" href="classgko_1_1matrix_1_1Csr.html#a068e5158cf282fa977f0a137f8cd7f03">get_row_ptrs</a>();</div>
<div class="line">    <span class="keyword">auto</span> col_idxs = matrix-&gt;<a class="code" href="classgko_1_1matrix_1_1Csr.html#a81c6294177a1be4873804c8a85a9fc64">get_col_idxs</a>();</div>
<div class="line">    <span class="keyword">auto</span> values = matrix-&gt;<a class="code" href="classgko_1_1matrix_1_1Csr.html#a929b0a194e6aeb1252b8e6781d162e83">get_values</a>();</div>
<div class="line">    IndexType pos = 0;</div>
<div class="line">    <span class="keyword">const</span> ValueType coefs[] = {-1, 2, -1};</div>
<div class="line">    row_ptrs[0] = pos;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; discretization_points; ++i) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> ofs : {-1, 0, 1}) {</div>
<div class="line">            <span class="keywordflow">if</span> (0 &lt;= i + ofs &amp;&amp; i + ofs &lt; discretization_points) {</div>
<div class="line">                values[pos] = coefs[ofs + 1];</div>
<div class="line">                col_idxs[pos] = i + ofs;</div>
<div class="line">                ++pos;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        row_ptrs[i + 1] = pos;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Closure, <span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">void</span> generate_rhs(Closure f, ValueType u0, ValueType u1,</div>
<div class="line">                  <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>* rhs)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> discretization_points = rhs-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0];</div>
<div class="line">    <span class="keyword">auto</span> values = rhs-&gt;<a class="code" href="classgko_1_1matrix_1_1Dense.html#a3bc458e02fab8e4c9f60f70bd4d5a4f9">get_values</a>();</div>
<div class="line">    <span class="keyword">const</span> ValueType h = 1.0 / (discretization_points + 1);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; discretization_points; ++i) {</div>
<div class="line">        <span class="keyword">const</span> ValueType xi = ValueType(i + 1) * h;</div>
<div class="line">        values[i] = -f(xi) * h * h;</div>
<div class="line">    }</div>
<div class="line">    values[0] += u0;</div>
<div class="line">    values[discretization_points - 1] += u1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">void</span> print_solution(ValueType u0, ValueType u1,</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>* u)</div>
<div class="line">{</div>
<div class="line">    std::cout &lt;&lt; u0 &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; u-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0]; ++i) {</div>
<div class="line">        std::cout &lt;&lt; u-&gt;<a class="code" href="classgko_1_1matrix_1_1Dense.html#ab83c739c1b11abaecc3bfd89506f6c9c">get_const_values</a>()[i] &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">    }</div>
<div class="line">    std::cout &lt;&lt; u1 &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Closure, <span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">double</span> calculate_error(<span class="keywordtype">int</span> discretization_points,</div>
<div class="line">                       <span class="keyword">const</span> <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>* u,</div>
<div class="line">                       Closure correct_u)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> h = 1.0 / (discretization_points + 1);</div>
<div class="line">    <span class="keyword">auto</span> error = 0.0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; discretization_points; ++i) {</div>
<div class="line">        <span class="keyword">using</span> std::abs;</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> xi = (i + 1) * h;</div>
<div class="line">        error +=</div>
<div class="line">            <a class="code" href="namespacegko.html#adeb470aaf293d7c5548392b2f451e8e4">abs</a>(u-&gt;<a class="code" href="classgko_1_1matrix_1_1Dense.html#ab83c739c1b11abaecc3bfd89506f6c9c">get_const_values</a>()[i] - correct_u(xi)) / <a class="code" href="namespacegko.html#adeb470aaf293d7c5548392b2f451e8e4">abs</a>(correct_u(xi));</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> error;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">using</span> ValueType = double;</div>
<div class="line">    <span class="keyword">using</span> RealValueType = <a class="code" href="namespacegko.html#afd46d554050c4ae90e84ea4fcd9a41f3">gko::remove_complex&lt;ValueType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> IndexType = int;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using</span> vec = <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> mtx = <a class="code" href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr&lt;ValueType, IndexType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> cg = <a class="code" href="classgko_1_1solver_1_1Cg.html">gko::solver::Cg&lt;ValueType&gt;</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (argc == 2 &amp;&amp; (std::string(argv[1]) == <span class="stringliteral">&quot;--help&quot;</span>)) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">&quot; [executor]&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::exit(-1);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> executor_string = argc &gt;= 2 ? argv[1] : <span class="stringliteral">&quot;reference&quot;</span>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> discretization_points =</div>
<div class="line">        argc &gt;= 3 ? std::atoi(argv[2]) : 100u;</div>
<div class="line">    std::map&lt;std::string, std::function&lt;std::shared_ptr&lt;gko::Executor&gt;()&gt;&gt;</div>
<div class="line">        exec_map{</div>
<div class="line">            {<span class="stringliteral">&quot;omp&quot;</span>, [] { <span class="keywordflow">return</span> <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>(); }},</div>
<div class="line">            {<span class="stringliteral">&quot;cuda&quot;</span>,</div>
<div class="line">             [] {</div>
<div class="line">                 <span class="keywordflow">return</span> <a class="code" href="classgko_1_1CudaExecutor.html#a5dcec3ca1c458382e01191b727959a81">gko::CudaExecutor::create</a>(0, <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>(),</div>
<div class="line">                                                  <span class="keyword">true</span>);</div>
<div class="line">             }},</div>
<div class="line">            {<span class="stringliteral">&quot;hip&quot;</span>,</div>
<div class="line">             [] {</div>
<div class="line">                 <span class="keywordflow">return</span> <a class="code" href="classgko_1_1HipExecutor.html#ad3a72bc42254fb8730bc2090147447d9">gko::HipExecutor::create</a>(0, <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>(),</div>
<div class="line">                                                 <span class="keyword">true</span>);</div>
<div class="line">             }},</div>
<div class="line">            {<span class="stringliteral">&quot;dpcpp&quot;</span>,</div>
<div class="line">             [] {</div>
<div class="line">                 <span class="keywordflow">return</span> <a class="code" href="classgko_1_1DpcppExecutor.html#ac46044fcb00b2d224b45d93eaf8c579d">gko::DpcppExecutor::create</a>(0,</div>
<div class="line">                                                   <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>());</div>
<div class="line">             }},</div>
<div class="line">            {<span class="stringliteral">&quot;reference&quot;</span>, [] { <span class="keywordflow">return</span> gko::ReferenceExecutor::create(); }}};</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> exec = exec_map.at(executor_string)();  <span class="comment">// throws if not valid</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> app_exec = exec-&gt;get_master();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> correct_u = [](ValueType x) { <span class="keywordflow">return</span> x * x * x; };</div>
<div class="line">    <span class="keyword">auto</span> f = [](ValueType x) { <span class="keywordflow">return</span> ValueType{6} * x; };</div>
<div class="line">    <span class="keyword">auto</span> u0 = correct_u(0);</div>
<div class="line">    <span class="keyword">auto</span> u1 = correct_u(1);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> rhs = vec::create(app_exec, <a class="code" href="structgko_1_1dim.html">gko::dim&lt;2&gt;</a>(discretization_points, 1));</div>
<div class="line">    generate_rhs(f, u0, u1, <a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(rhs));</div>
<div class="line">    <span class="keyword">auto</span> u = vec::create(app_exec, <a class="code" href="structgko_1_1dim.html">gko::dim&lt;2&gt;</a>(discretization_points, 1));</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; u-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0]; ++i) {</div>
<div class="line">        u-&gt;<a class="code" href="classgko_1_1matrix_1_1Dense.html#a3bc458e02fab8e4c9f60f70bd4d5a4f9">get_values</a>()[i] = 0.0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> RealValueType reduction_factor{1e-7};</div>
<div class="line">    cg::build()</div>
<div class="line">        .with_criteria(gko::stop::Iteration::build()</div>
<div class="line">                           .with_max_iters(discretization_points)</div>
<div class="line">                           .on(exec),</div>
<div class="line">                       <a class="code" href="classgko_1_1stop_1_1ResidualNorm.html">gko::stop::ResidualNorm&lt;ValueType&gt;::build</a>()</div>
<div class="line">                           .with_reduction_factor(reduction_factor)</div>
<div class="line">                           .on(exec))</div>
<div class="line">        .on(exec)</div>
<div class="line">        -&gt;generate(StencilMatrix&lt;ValueType&gt;::create(exec, discretization_points,</div>
<div class="line">                                                    -1, 2, -1))</div>
<div class="line">        -&gt;apply(<a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(rhs), <a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(u));</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;\nSolve complete.&quot;</span></div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;\nThe average relative error is &quot;</span></div>
<div class="line">              &lt;&lt; calculate_error(discretization_points, <a class="code" href="namespacegko.html#a014ec51e675c425bb83908361f630450">lend</a>(u), correct_u) /</div>
<div class="line">                     discretization_points</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="aclassgko_1_1matrix_1_1Csr_html_a81c6294177a1be4873804c8a85a9fc64"><div class="ttname"><a href="classgko_1_1matrix_1_1Csr.html#a81c6294177a1be4873804c8a85a9fc64">gko::matrix::Csr::get_col_idxs</a></div><div class="ttdeci">index_type * get_col_idxs() noexcept</div><div class="ttdoc">Returns the column indexes of the matrix.</div><div class="ttdef"><b>Definition:</b> csr.hpp:813</div></div>
<div class="ttc" id="aclassgko_1_1matrix_1_1Csr_html"><div class="ttname"><a href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr</a></div><div class="ttdoc">CSR is a matrix format which stores only the nonzero coefficients by compressing each row of the matr...</div><div class="ttdef"><b>Definition:</b> coo.hpp:51</div></div>
<div class="ttc" id="aclassgko_1_1LinOp_html"><div class="ttname"><a href="classgko_1_1LinOp.html">gko::LinOp</a></div><div class="ttdef"><b>Definition:</b> lin_op.hpp:146</div></div>
<div class="ttc" id="aclassgko_1_1matrix_1_1Dense_html"><div class="ttname"><a href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense</a></div><div class="ttdoc">Dense is a matrix format which explicitly stores all values of the matrix.</div><div class="ttdef"><b>Definition:</b> mtx_io.hpp:252</div></div>
<div class="ttc" id="aclassgko_1_1EnableCreateMethod_html"><div class="ttname"><a href="classgko_1_1EnableCreateMethod.html">gko::EnableCreateMethod</a></div><div class="ttdoc">This mixin implements a static create() method on ConcreteType that dynamically allocates the memory,...</div><div class="ttdef"><b>Definition:</b> polymorphic_object.hpp:728</div></div>
<div class="ttc" id="aclassgko_1_1OmpExecutor_html_a33ca05fdd0fc928ee262fc9425304874"><div class="ttname"><a href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a></div><div class="ttdeci">static std::shared_ptr&lt; OmpExecutor &gt; create()</div><div class="ttdoc">Creates a new OmpExecutor.</div><div class="ttdef"><b>Definition:</b> executor.hpp:1220</div></div>
<div class="ttc" id="anamespacegko_html_a6e5c95df0ae4e47aab2f604a22d98ee7"><div class="ttname"><a href="namespacegko.html#a6e5c95df0ae4e47aab2f604a22d98ee7">gko::size_type</a></div><div class="ttdeci">std::size_t size_type</div><div class="ttdoc">Integral type used for allocation quantities.</div><div class="ttdef"><b>Definition:</b> types.hpp:105</div></div>
<div class="ttc" id="anamespacegko_html_adeb470aaf293d7c5548392b2f451e8e4"><div class="ttname"><a href="namespacegko.html#adeb470aaf293d7c5548392b2f451e8e4">gko::abs</a></div><div class="ttdeci">constexpr xstd::enable_if_t&lt;!is_complex_s&lt; T &gt;::value, T &gt; abs(const T &amp;x)</div><div class="ttdoc">Returns the absolute value of the object.</div><div class="ttdef"><b>Definition:</b> math.hpp:1099</div></div>
<div class="ttc" id="anamespacegko_html"><div class="ttname"><a href="namespacegko.html">gko</a></div><div class="ttdoc">The Ginkgo namespace.</div><div class="ttdef"><b>Definition:</b> abstract_factory.hpp:45</div></div>
<div class="ttc" id="aclassgko_1_1matrix_1_1Dense_html_a3bc458e02fab8e4c9f60f70bd4d5a4f9"><div class="ttname"><a href="classgko_1_1matrix_1_1Dense.html#a3bc458e02fab8e4c9f60f70bd4d5a4f9">gko::matrix::Dense::get_values</a></div><div class="ttdeci">value_type * get_values() noexcept</div><div class="ttdoc">Returns a pointer to the array of values of the matrix.</div><div class="ttdef"><b>Definition:</b> dense.hpp:604</div></div>
<div class="ttc" id="aclassgko_1_1array_html"><div class="ttname"><a href="classgko_1_1array.html">gko::array</a></div><div class="ttdoc">An array is a container which encapsulates fixed-sized arrays, stored on the Executor tied to the arr...</div><div class="ttdef"><b>Definition:</b> array.hpp:55</div></div>
<div class="ttc" id="aclassgko_1_1stop_1_1ResidualNorm_html"><div class="ttname"><a href="classgko_1_1stop_1_1ResidualNorm.html">gko::stop::ResidualNorm</a></div><div class="ttdoc">The ResidualNorm class is a stopping criterion which stops the iteration process when the actual resi...</div><div class="ttdef"><b>Definition:</b> residual_norm.hpp:213</div></div>
<div class="ttc" id="aclassgko_1_1matrix_1_1Csr_html_a068e5158cf282fa977f0a137f8cd7f03"><div class="ttname"><a href="classgko_1_1matrix_1_1Csr.html#a068e5158cf282fa977f0a137f8cd7f03">gko::matrix::Csr::get_row_ptrs</a></div><div class="ttdeci">index_type * get_row_ptrs() noexcept</div><div class="ttdoc">Returns the row pointers of the matrix.</div><div class="ttdef"><b>Definition:</b> csr.hpp:832</div></div>
<div class="ttc" id="astructgko_1_1dim_html"><div class="ttname"><a href="structgko_1_1dim.html">gko::dim&lt; 2 &gt;</a></div></div>
<div class="ttc" id="aclassgko_1_1solver_1_1Cg_html"><div class="ttname"><a href="classgko_1_1solver_1_1Cg.html">gko::solver::Cg</a></div><div class="ttdoc">CG or the conjugate gradient method is an iterative type Krylov subspace method which is suitable for...</div><div class="ttdef"><b>Definition:</b> cg.hpp:74</div></div>
<div class="ttc" id="aclassgko_1_1CudaExecutor_html_a5dcec3ca1c458382e01191b727959a81"><div class="ttname"><a href="classgko_1_1CudaExecutor.html#a5dcec3ca1c458382e01191b727959a81">gko::CudaExecutor::create</a></div><div class="ttdeci">static std::shared_ptr&lt; CudaExecutor &gt; create(int device_id, std::shared_ptr&lt; Executor &gt; master, bool device_reset=false, allocation_mode alloc_mode=default_cuda_alloc_mode)</div><div class="ttdoc">Creates a new CudaExecutor.</div></div>
<div class="ttc" id="aclassgko_1_1DpcppExecutor_html_ac46044fcb00b2d224b45d93eaf8c579d"><div class="ttname"><a href="classgko_1_1DpcppExecutor.html#ac46044fcb00b2d224b45d93eaf8c579d">gko::DpcppExecutor::create</a></div><div class="ttdeci">static std::shared_ptr&lt; DpcppExecutor &gt; create(int device_id, std::shared_ptr&lt; Executor &gt; master, std::string device_type=&quot;all&quot;)</div><div class="ttdoc">Creates a new DpcppExecutor.</div></div>
<div class="ttc" id="anamespacegko_html_a014ec51e675c425bb83908361f630450"><div class="ttname"><a href="namespacegko.html#a014ec51e675c425bb83908361f630450">gko::lend</a></div><div class="ttdeci">std::enable_if&lt; detail::have_ownership_s&lt; Pointer &gt;::value, detail::pointee&lt; Pointer &gt; * &gt;::type lend(const Pointer &amp;p)</div><div class="ttdoc">Returns a non-owning (plain) pointer to the object pointed to by p.</div><div class="ttdef"><b>Definition:</b> utils_helper.hpp:256</div></div>
<div class="ttc" id="aclassgko_1_1matrix_1_1Dense_html_ab83c739c1b11abaecc3bfd89506f6c9c"><div class="ttname"><a href="classgko_1_1matrix_1_1Dense.html#ab83c739c1b11abaecc3bfd89506f6c9c">gko::matrix::Dense::get_const_values</a></div><div class="ttdeci">const value_type * get_const_values() const noexcept</div><div class="ttdoc">Returns a pointer to the array of values of the matrix.</div><div class="ttdef"><b>Definition:</b> dense.hpp:613</div></div>
<div class="ttc" id="aclassgko_1_1HipExecutor_html_ad3a72bc42254fb8730bc2090147447d9"><div class="ttname"><a href="classgko_1_1HipExecutor.html#ad3a72bc42254fb8730bc2090147447d9">gko::HipExecutor::create</a></div><div class="ttdeci">static std::shared_ptr&lt; HipExecutor &gt; create(int device_id, std::shared_ptr&lt; Executor &gt; master, bool device_reset=false, allocation_mode alloc_mode=default_hip_alloc_mode)</div><div class="ttdoc">Creates a new HipExecutor.</div></div>
<div class="ttc" id="aclassgko_1_1LinOp_html_a31b3c003388eb0b95393154f68c2b98d"><div class="ttname"><a href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">gko::LinOp::get_size</a></div><div class="ttdeci">const dim&lt; 2 &gt; &amp; get_size() const noexcept</div><div class="ttdoc">Returns the size of the operator.</div><div class="ttdef"><b>Definition:</b> lin_op.hpp:233</div></div>
<div class="ttc" id="anamespacegko_html_afd46d554050c4ae90e84ea4fcd9a41f3"><div class="ttname"><a href="namespacegko.html#afd46d554050c4ae90e84ea4fcd9a41f3">gko::remove_complex</a></div><div class="ttdeci">typename detail::remove_complex_s&lt; T &gt;::type remove_complex</div><div class="ttdoc">Obtain the type which removed the complex of complex/scalar type or the template parameter of class b...</div><div class="ttdef"><b>Definition:</b> math.hpp:359</div></div>
<div class="ttc" id="aclassgko_1_1EnableLinOp_html"><div class="ttname"><a href="classgko_1_1EnableLinOp.html">gko::EnableLinOp</a></div><div class="ttdoc">The EnableLinOp mixin can be used to provide sensible default implementations of the majority of the ...</div><div class="ttdef"><b>Definition:</b> lin_op.hpp:870</div></div>
<div class="ttc" id="aclassgko_1_1Operation_html"><div class="ttname"><a href="classgko_1_1Operation.html">gko::Operation</a></div><div class="ttdoc">Operations can be used to define functionalities whose implementations differ among devices.</div><div class="ttdef"><b>Definition:</b> executor.hpp:259</div></div>
<div class="ttc" id="aclassgko_1_1matrix_1_1Csr_html_a929b0a194e6aeb1252b8e6781d162e83"><div class="ttname"><a href="classgko_1_1matrix_1_1Csr.html#a929b0a194e6aeb1252b8e6781d162e83">gko::matrix::Csr::get_values</a></div><div class="ttdeci">value_type * get_values() noexcept</div><div class="ttdoc">Returns the values of the matrix.</div><div class="ttdef"><b>Definition:</b> csr.hpp:794</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>

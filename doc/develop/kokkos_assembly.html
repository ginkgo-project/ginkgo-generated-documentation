<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ginkgo: The kokkos-assembly program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_doc.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Ginkgo
   &#160;<span id="projectnumber">Generated from pipelines/1304274478 branch based on develop. Ginkgo version 1.8.0</span>
   </div>
   <div id="projectbrief">A numerical linear algebra library targeting many-core architectures</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The kokkos-assembly program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Kokkos assembly example..</p>
<p>This example depends on simple-solver, poisson-solver, three-pt-stencil-solver, .</p>
<p> 
<table class="example" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Notes"> Notes </a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>This example solves a 1D Poisson equation:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ u : [0, 1] \rightarrow R\\ u'' = f\\ u(0) = u0\\ u(1) = u1 \]" src="form_138.png"/>
</p>
<p>using a finite difference method on an equidistant grid with <code>K</code> discretization points (<code>K</code> can be controlled with a command line parameter).</p>
<p>The resulting CSR matrix is assembled using Kokkos kernels. This example show how to use Ginkgo data with Kokkos kernels.</p>
<p><a class="anchor" id="Notes"></a></p><h3>Notes </h3>
<p>If this example is built as part of Ginkgo, it is advised to configure Ginkgo with <code>-DGINKGO_WITH_CCACHE=OFF</code> to prevent incompabilities with Kokkos' compiler wrapper for <code>nvcc</code>.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<div class="fragment"><div class="line">     * of arrays.</div>
<div class="line">     *</div>
<div class="line">     * @tparam ValueType_c  The value type of the matrix elements, might have</div>
<div class="line">     *                      other cv qualifiers than ValueType</div>
<div class="line">     * @tparam IndexType_c  The index type of the matrix elements, might have</div>
<div class="line">     *                      other cv qualifiers than IndexType</div>
<div class="line">     * /</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType_c, <span class="keyword">typename</span> IndexType_c&gt;</div>
<div class="line">    <span class="keyword">struct </span>type {</div>
<div class="line">        <span class="keyword">using</span> index_array = <span class="keyword">typename</span> index_mapper::template type&lt;IndexType_c&gt;;</div>
<div class="line">        <span class="keyword">using</span> value_array = <span class="keyword">typename</span> value_mapper::template type&lt;ValueType_c&gt;;</div>
<div class="line"> </div>
<div class="line">        / **</div>
<div class="line">         * Constructor based on size and raw pointers</div>
<div class="line">         *</div>
<div class="line">         * @param size  The number of stored elements</div>
<div class="line">         * @param row_idxs  Pointer to the row indices</div>
<div class="line">         * @param col_idxs  Pointer to the column indices</div>
<div class="line">         * @param values  Pointer to the values</div>
<div class="line">         *</div>
<div class="line">         * @<span class="keywordflow">return</span>  An <span class="keywordtype">object</span> which has each <a class="code" href="classgko_1_1array.html">gko::array</a> of the</div>
<div class="line">         *          device_matrix_data mapped to a Kokkos view</div>
<div class="line">         * /</div>
<div class="line">        <span class="keyword">static</span> type map(size_type size, IndexType_c* row_idxs,</div>
<div class="line">                        IndexType_c* col_idxs, ValueType_c* values)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> {index_mapper::map(row_idxs, size),</div>
<div class="line">                    index_mapper::map(col_idxs, size),</div>
<div class="line">                    value_mapper::map(values, size)};</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        index_array row_idxs;</div>
<div class="line">        index_array col_idxs;</div>
<div class="line">        value_array values;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> type&lt;ValueType, IndexType&gt; map(</div>
<div class="line">        device_matrix_data&lt;ValueType, IndexType&gt;&amp; md)</div>
<div class="line">    {</div>
<div class="line">        assert_compatibility&lt;MemorySpace&gt;(md);</div>
<div class="line">        <span class="keywordflow">return</span> type&lt;ValueType, IndexType&gt;::map(</div>
<div class="line">            md.get_num_stored_elements(), md.get_row_idxs(), md.get_col_idxs(),</div>
<div class="line">            md.get_values());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> type&lt;const ValueType, const IndexType&gt; map(</div>
<div class="line">        <span class="keyword">const</span> device_matrix_data&lt;ValueType, IndexType&gt;&amp; md)</div>
<div class="line">    {</div>
<div class="line">        assert_compatibility&lt;MemorySpace&gt;(md);</div>
<div class="line">        <span class="keywordflow">return</span> type&lt;const ValueType, const IndexType&gt;::map(</div>
<div class="line">            md.get_num_stored_elements(), md.get_const_row_idxs(),</div>
<div class="line">            md.get_const_col_idxs(), md.get_const_values());</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace gko::ext::kokkos::detail</span></div>
</div><!-- fragment --><p>Creates a stencil matrix in CSR format for the given number of discretization points.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType, <span class="keyword">typename</span> IndexType&gt;</div>
<div class="line"><span class="keywordtype">void</span> generate_stencil_matrix(<a class="code" href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr&lt;ValueType, IndexType&gt;</a>* matrix)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">auto</span> exec = matrix-&gt;<a class="code" href="classgko_1_1PolymorphicObject.html#ab40586bff071b7f11c2cf6b5cbf598eb">get_executor</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> discretization_points = matrix-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0];</div>
</div><!-- fragment --><p>Over-allocate storage for the matrix elements. Each row has 3 entries, except for the first and last one. To handle each row uniformly, we allocate space for 3x the number of rows.</p>
<div class="fragment"><div class="line"><a class="code" href="classgko_1_1device__matrix__data.html">gko::device_matrix_data&lt;ValueType, IndexType&gt;</a> md(exec, matrix-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>(),</div>
<div class="line">                                                 discretization_points * 3);</div>
</div><!-- fragment --><p>Create Kokkos views on Ginkgo data.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> k_md = gko::ext::kokkos::map_data(md);</div>
</div><!-- fragment --><p>Create the matrix entries. This also creates zero entries for the first and second row to handle all rows uniformly.</p>
<div class="fragment"><div class="line">Kokkos::parallel_for(</div>
<div class="line">    <span class="stringliteral">&quot;generate_stencil_matrix&quot;</span>, md.get_num_stored_elements(),</div>
<div class="line">    KOKKOS_LAMBDA(<span class="keywordtype">int</span> i) {</div>
<div class="line">        <span class="keyword">const</span> ValueType coefs[] = {-1, 2, -1};</div>
<div class="line">        <span class="keyword">auto</span> ofs = static_cast&lt;IndexType&gt;((i % 3) - 1);</div>
<div class="line">        <span class="keyword">auto</span> row = static_cast&lt;IndexType&gt;(i / 3);</div>
<div class="line">        <span class="keyword">auto</span> col = row + ofs;</div>
</div><!-- fragment --><p>To prevent branching, a mask is used to set the entry to zero, if the column is out-of-bounds</p>
<div class="fragment"><div class="line">    <span class="keyword">auto</span> mask =</div>
<div class="line">        static_cast&lt;IndexType&gt;(0 &lt;= col &amp;&amp; col &lt; discretization_points);</div>
<div class="line"> </div>
<div class="line">    k_md.row_idxs[i] = mask * row;</div>
<div class="line">    k_md.col_idxs[i] = mask * col;</div>
<div class="line">    k_md.values[i] = mask * coefs[ofs + 1];</div>
<div class="line">});</div>
</div><!-- fragment --><p>Add up duplicate (zero) entries.</p>
<div class="fragment"><div class="line">md.sum_duplicates();</div>
</div><!-- fragment --><p>Build Csr matrix.</p>
<div class="fragment"><div class="line">    matrix-&gt;<a class="code" href="classgko_1_1matrix_1_1Csr.html#ac4db41146ed3c3a8653b03d6b2c6c675">read</a>(std::move(md));</div>
<div class="line">}</div>
</div><!-- fragment --><p>Generates the RHS vector given <code>f</code> and the boundary conditions.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Closure, <span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">void</span> generate_rhs(Closure&amp;&amp; f, ValueType u0, ValueType u1,</div>
<div class="line">                  <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>* rhs)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> discretization_points = <a class="code" href="namespacegko_1_1solver.html#a82d21321745fbd3dc65c276d5838bb8aa83ff9f9e3dd7561d3dd91204cf546b7e">rhs</a>-&gt;get_size()[0];</div>
<div class="line">    <span class="keyword">auto</span> k_rhs = gko::ext::kokkos::map_data(rhs);</div>
<div class="line">    Kokkos::parallel_for(</div>
<div class="line">        <span class="stringliteral">&quot;generate_rhs&quot;</span>, discretization_points, KOKKOS_LAMBDA(<span class="keywordtype">int</span> i) {</div>
<div class="line">            <span class="keyword">const</span> ValueType h = 1.0 / (discretization_points + 1);</div>
<div class="line">            <span class="keyword">const</span> ValueType xi = ValueType(i + 1) * h;</div>
<div class="line">            k_rhs(i, 0) = -f(xi) * h * h;</div>
<div class="line">            <span class="keywordflow">if</span> (i == 0) {</div>
<div class="line">                k_rhs(i, 0) += u0;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (i == discretization_points - 1) {</div>
<div class="line">                k_rhs(i, 0) += u1;</div>
<div class="line">            }</div>
<div class="line">        });</div>
<div class="line">}</div>
</div><!-- fragment --><p>Computes the 1-norm of the error given the computed <code>u</code> and the correct solution function <code>correct_u</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Closure, <span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">double</span> calculate_error(<span class="keywordtype">int</span> discretization_points,</div>
<div class="line">                       <span class="keyword">const</span> <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>* u,</div>
<div class="line">                       Closure&amp;&amp; correct_u)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">auto</span> k_u = gko::ext::kokkos::map_data(u);</div>
<div class="line">    <span class="keyword">auto</span> error = 0.0;</div>
<div class="line">    Kokkos::parallel_reduce(</div>
<div class="line">        <span class="stringliteral">&quot;calculate_error&quot;</span>, discretization_points,</div>
<div class="line">        KOKKOS_LAMBDA(<span class="keywordtype">int</span> i, <span class="keywordtype">double</span>&amp; lsum) {</div>
<div class="line">            <span class="keyword">const</span> <span class="keyword">auto</span> h = 1.0 / (discretization_points + 1);</div>
<div class="line">            <span class="keyword">const</span> <span class="keyword">auto</span> xi = (i + 1) * h;</div>
<div class="line">            lsum += Kokkos::abs((k_u(i, 0) - correct_u(xi)) /</div>
<div class="line">                                Kokkos::abs(correct_u(xi)));</div>
<div class="line">        },</div>
<div class="line">        error);</div>
<div class="line">    <span class="keywordflow">return</span> error;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
</div><!-- fragment --><p>Some shortcuts</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> ValueType = double;</div>
<div class="line"><span class="keyword">using</span> RealValueType = <a class="code" href="namespacegko.html#afd46d554050c4ae90e84ea4fcd9a41f3">gko::remove_complex&lt;ValueType&gt;</a>;</div>
<div class="line"><span class="keyword">using</span> IndexType = int;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using</span> vec = <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>;</div>
<div class="line"><span class="keyword">using</span> mtx = <a class="code" href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr&lt;ValueType, IndexType&gt;</a>;</div>
<div class="line"><span class="keyword">using</span> cg = <a class="code" href="classgko_1_1solver_1_1Cg.html">gko::solver::Cg&lt;ValueType&gt;</a>;</div>
<div class="line"><span class="keyword">using</span> bj = <a class="code" href="classgko_1_1preconditioner_1_1Jacobi.html">gko::preconditioner::Jacobi&lt;ValueType&gt;</a>;</div>
</div><!-- fragment --><p>Print help message. For details on the kokkos-options see <a href="https://kokkos.github.io/kokkos-core-wiki/ProgrammingGuide/Initialization.html#initialization-by-command-line-arguments">https://kokkos.github.io/kokkos-core-wiki/ProgrammingGuide/Initialization.html#initialization-by-command-line-arguments</a></p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (argc == 2 &amp;&amp; (std::string(argv[1]) == <span class="stringliteral">&quot;--help&quot;</span>)) {</div>
<div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0]</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; [discretization_points] [kokkos-options]&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    Kokkos::ScopeGuard kokkos(argc, argv);  <span class="comment">// print Kokkos help</span></div>
<div class="line">    std::exit(1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">Kokkos::ScopeGuard kokkos(argc, argv);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> discretization_points =</div>
<div class="line">    static_cast&lt;gko::size_type&gt;(argc &gt;= 2 ? std::atoi(argv[1]) : 100u);</div>
</div><!-- fragment --><p>chooses the executor that corresponds to the Kokkos DefaultExecutionSpace</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> exec = gko::ext::kokkos::create_default_executor();</div>
</div><!-- fragment --><p>problem:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> correct_u = [] KOKKOS_FUNCTION(ValueType x) { <span class="keywordflow">return</span> x * x * x; };</div>
<div class="line"><span class="keyword">auto</span> f = [] KOKKOS_FUNCTION(ValueType x) { <span class="keywordflow">return</span> ValueType{6} * x; };</div>
<div class="line"><span class="keyword">auto</span> u0 = correct_u(0);</div>
<div class="line"><span class="keyword">auto</span> u1 = correct_u(1);</div>
</div><!-- fragment --><p>initialize vectors</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> <a class="code" href="namespacegko_1_1solver.html#a82d21321745fbd3dc65c276d5838bb8aa83ff9f9e3dd7561d3dd91204cf546b7e">rhs</a> = vec::create(exec, <a class="code" href="structgko_1_1dim.html">gko::dim&lt;2&gt;</a>(discretization_points, 1));</div>
<div class="line">generate_rhs(f, u0, u1, <a class="code" href="namespacegko_1_1solver.html#a82d21321745fbd3dc65c276d5838bb8aa83ff9f9e3dd7561d3dd91204cf546b7e">rhs</a>.get());</div>
<div class="line"><span class="keyword">auto</span> u = vec::create(exec, <a class="code" href="structgko_1_1dim.html">gko::dim&lt;2&gt;</a>(discretization_points, 1));</div>
<div class="line">u-&gt;fill(0.0);</div>
</div><!-- fragment --><p>initialize the stencil matrix</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> A = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">share</a>(mtx::create(</div>
<div class="line">    exec, <a class="code" href="structgko_1_1dim.html">gko::dim&lt;2&gt;</a>{discretization_points, discretization_points}));</div>
<div class="line">generate_stencil_matrix(A.get());</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> RealValueType reduction_factor{1e-7};</div>
</div><!-- fragment --><p>Generate solver and solve the system</p>
<div class="fragment"><div class="line">    cg::build()</div>
<div class="line">        .with_criteria(</div>
<div class="line">            gko::stop::Iteration::build().with_max_iters(discretization_points),</div>
<div class="line">            <a class="code" href="classgko_1_1stop_1_1ResidualNorm.html">gko::stop::ResidualNorm&lt;ValueType&gt;::build</a>().with_reduction_factor(</div>
<div class="line">                reduction_factor))</div>
<div class="line">        .with_preconditioner(bj::build())</div>
<div class="line">        .on(exec)</div>
<div class="line">        -&gt;generate(A)</div>
<div class="line">        -&gt;apply(rhs, u);</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;\nSolve complete.&quot;</span></div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;\nThe average relative error is &quot;</span></div>
<div class="line">              &lt;&lt; calculate_error(discretization_points, u.get(), correct_u) /</div>
<div class="line">                     discretization_points</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>Example output: </p><div class="fragment"><div class="line">&gt; ./kokkos-assembly</div>
<div class="line"> </div>
<div class="line">Solve complete.</div>
<div class="line">The average relative error is 1.05488e-11</div>
</div><!-- fragment --><p>The actual error depends on the used hardware. <a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;Kokkos_Core.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;ginkgo/extensions/kokkos.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;ginkgo/ginkgo.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>gko::ext::kokkos::detail {</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType, <span class="keyword">typename</span> IndexType, <span class="keyword">typename</span> MemorySpace&gt;</div>
<div class="line"><span class="keyword">struct </span>mapper&lt;device_matrix_data&lt;ValueType, IndexType&gt;, MemorySpace&gt; {</div>
<div class="line">    <span class="keyword">using</span> index_mapper = mapper&lt;array&lt;IndexType&gt;, MemorySpace&gt;;</div>
<div class="line">    <span class="keyword">using</span> value_mapper = mapper&lt;array&lt;ValueType&gt;, MemorySpace&gt;;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType_c, <span class="keyword">typename</span> IndexType_c&gt;</div>
<div class="line">    <span class="keyword">struct </span>type {</div>
<div class="line">        <span class="keyword">using</span> index_array = <span class="keyword">typename</span> index_mapper::template type&lt;IndexType_c&gt;;</div>
<div class="line">        <span class="keyword">using</span> value_array = <span class="keyword">typename</span> value_mapper::template type&lt;ValueType_c&gt;;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">static</span> type map(<a class="code" href="namespacegko.html#a6e5c95df0ae4e47aab2f604a22d98ee7">size_type</a> size, IndexType_c* row_idxs,</div>
<div class="line">                        IndexType_c* col_idxs, ValueType_c* values)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> {index_mapper::map(row_idxs, size),</div>
<div class="line">                    index_mapper::map(col_idxs, size),</div>
<div class="line">                    value_mapper::map(values, size)};</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        index_array row_idxs;</div>
<div class="line">        index_array col_idxs;</div>
<div class="line">        value_array values;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> type&lt;ValueType, IndexType&gt; map(</div>
<div class="line">        device_matrix_data&lt;ValueType, IndexType&gt;&amp; md)</div>
<div class="line">    {</div>
<div class="line">        assert_compatibility&lt;MemorySpace&gt;(md);</div>
<div class="line">        <span class="keywordflow">return</span> type&lt;ValueType, IndexType&gt;::map(</div>
<div class="line">            md.get_num_stored_elements(), md.get_row_idxs(), md.get_col_idxs(),</div>
<div class="line">            md.get_values());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> type&lt;const ValueType, const IndexType&gt; map(</div>
<div class="line">        <span class="keyword">const</span> device_matrix_data&lt;ValueType, IndexType&gt;&amp; md)</div>
<div class="line">    {</div>
<div class="line">        assert_compatibility&lt;MemorySpace&gt;(md);</div>
<div class="line">        <span class="keywordflow">return</span> type&lt;const ValueType, const IndexType&gt;::map(</div>
<div class="line">            md.get_num_stored_elements(), md.get_const_row_idxs(),</div>
<div class="line">            md.get_const_col_idxs(), md.get_const_values());</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace gko::ext::kokkos::detail</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType, <span class="keyword">typename</span> IndexType&gt;</div>
<div class="line"><span class="keywordtype">void</span> generate_stencil_matrix(<a class="code" href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr&lt;ValueType, IndexType&gt;</a>* matrix)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">auto</span> exec = matrix-&gt;<a class="code" href="classgko_1_1PolymorphicObject.html#ab40586bff071b7f11c2cf6b5cbf598eb">get_executor</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> discretization_points = matrix-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0];</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classgko_1_1device__matrix__data.html">gko::device_matrix_data&lt;ValueType, IndexType&gt;</a> md(exec, matrix-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>(),</div>
<div class="line">                                                     discretization_points * 3);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> k_md = gko::ext::kokkos::map_data(md);</div>
<div class="line"> </div>
<div class="line">    Kokkos::parallel_for(</div>
<div class="line">        <span class="stringliteral">&quot;generate_stencil_matrix&quot;</span>, md.get_num_stored_elements(),</div>
<div class="line">        KOKKOS_LAMBDA(<span class="keywordtype">int</span> i) {</div>
<div class="line">            <span class="keyword">const</span> ValueType coefs[] = {-1, 2, -1};</div>
<div class="line">            <span class="keyword">auto</span> ofs = static_cast&lt;IndexType&gt;((i % 3) - 1);</div>
<div class="line">            <span class="keyword">auto</span> row = static_cast&lt;IndexType&gt;(i / 3);</div>
<div class="line">            <span class="keyword">auto</span> col = row + ofs;</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">auto</span> mask =</div>
<div class="line">                static_cast&lt;IndexType&gt;(0 &lt;= col &amp;&amp; col &lt; discretization_points);</div>
<div class="line"> </div>
<div class="line">            k_md.row_idxs[i] = mask * row;</div>
<div class="line">            k_md.col_idxs[i] = mask * col;</div>
<div class="line">            k_md.values[i] = mask * coefs[ofs + 1];</div>
<div class="line">        });</div>
<div class="line"> </div>
<div class="line">    md.sum_duplicates();</div>
<div class="line"> </div>
<div class="line">    matrix-&gt;<a class="code" href="classgko_1_1matrix_1_1Csr.html#ac4db41146ed3c3a8653b03d6b2c6c675">read</a>(std::move(md));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Closure, <span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">void</span> generate_rhs(Closure&amp;&amp; f, ValueType u0, ValueType u1,</div>
<div class="line">                  <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>* rhs)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> discretization_points = <a class="code" href="namespacegko_1_1solver.html#a82d21321745fbd3dc65c276d5838bb8aa83ff9f9e3dd7561d3dd91204cf546b7e">rhs</a>-&gt;get_size()[0];</div>
<div class="line">    <span class="keyword">auto</span> k_rhs = gko::ext::kokkos::map_data(rhs);</div>
<div class="line">    Kokkos::parallel_for(</div>
<div class="line">        <span class="stringliteral">&quot;generate_rhs&quot;</span>, discretization_points, KOKKOS_LAMBDA(<span class="keywordtype">int</span> i) {</div>
<div class="line">            <span class="keyword">const</span> ValueType h = 1.0 / (discretization_points + 1);</div>
<div class="line">            <span class="keyword">const</span> ValueType xi = ValueType(i + 1) * h;</div>
<div class="line">            k_rhs(i, 0) = -f(xi) * h * h;</div>
<div class="line">            <span class="keywordflow">if</span> (i == 0) {</div>
<div class="line">                k_rhs(i, 0) += u0;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (i == discretization_points - 1) {</div>
<div class="line">                k_rhs(i, 0) += u1;</div>
<div class="line">            }</div>
<div class="line">        });</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Closure, <span class="keyword">typename</span> ValueType&gt;</div>
<div class="line"><span class="keywordtype">double</span> calculate_error(<span class="keywordtype">int</span> discretization_points,</div>
<div class="line">                       <span class="keyword">const</span> <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>* u,</div>
<div class="line">                       Closure&amp;&amp; correct_u)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">auto</span> k_u = gko::ext::kokkos::map_data(u);</div>
<div class="line">    <span class="keyword">auto</span> error = 0.0;</div>
<div class="line">    Kokkos::parallel_reduce(</div>
<div class="line">        <span class="stringliteral">&quot;calculate_error&quot;</span>, discretization_points,</div>
<div class="line">        KOKKOS_LAMBDA(<span class="keywordtype">int</span> i, <span class="keywordtype">double</span>&amp; lsum) {</div>
<div class="line">            <span class="keyword">const</span> <span class="keyword">auto</span> h = 1.0 / (discretization_points + 1);</div>
<div class="line">            <span class="keyword">const</span> <span class="keyword">auto</span> xi = (i + 1) * h;</div>
<div class="line">            lsum += Kokkos::abs((k_u(i, 0) - correct_u(xi)) /</div>
<div class="line">                                Kokkos::abs(correct_u(xi)));</div>
<div class="line">        },</div>
<div class="line">        error);</div>
<div class="line">    <span class="keywordflow">return</span> error;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">using</span> ValueType = double;</div>
<div class="line">    <span class="keyword">using</span> RealValueType = <a class="code" href="namespacegko.html#afd46d554050c4ae90e84ea4fcd9a41f3">gko::remove_complex&lt;ValueType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> IndexType = int;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using</span> vec = <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;ValueType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> mtx = <a class="code" href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr&lt;ValueType, IndexType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> cg = <a class="code" href="classgko_1_1solver_1_1Cg.html">gko::solver::Cg&lt;ValueType&gt;</a>;</div>
<div class="line">    <span class="keyword">using</span> bj = <a class="code" href="classgko_1_1preconditioner_1_1Jacobi.html">gko::preconditioner::Jacobi&lt;ValueType&gt;</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (argc == 2 &amp;&amp; (std::string(argv[1]) == <span class="stringliteral">&quot;--help&quot;</span>)) {</div>
<div class="line">        std::cerr &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0]</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot; [discretization_points] [kokkos-options]&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        Kokkos::ScopeGuard kokkos(argc, argv);  <span class="comment">// print Kokkos help</span></div>
<div class="line">        std::exit(1);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    Kokkos::ScopeGuard kokkos(argc, argv);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> discretization_points =</div>
<div class="line">        static_cast&lt;gko::size_type&gt;(argc &gt;= 2 ? std::atoi(argv[1]) : 100u);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> exec = gko::ext::kokkos::create_default_executor();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> correct_u = [] KOKKOS_FUNCTION(ValueType x) { <span class="keywordflow">return</span> x * x * x; };</div>
<div class="line">    <span class="keyword">auto</span> f = [] KOKKOS_FUNCTION(ValueType x) { <span class="keywordflow">return</span> ValueType{6} * x; };</div>
<div class="line">    <span class="keyword">auto</span> u0 = correct_u(0);</div>
<div class="line">    <span class="keyword">auto</span> u1 = correct_u(1);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> <a class="code" href="namespacegko_1_1solver.html#a82d21321745fbd3dc65c276d5838bb8aa83ff9f9e3dd7561d3dd91204cf546b7e">rhs</a> = vec::create(exec, <a class="code" href="structgko_1_1dim.html">gko::dim&lt;2&gt;</a>(discretization_points, 1));</div>
<div class="line">    generate_rhs(f, u0, u1, <a class="code" href="namespacegko_1_1solver.html#a82d21321745fbd3dc65c276d5838bb8aa83ff9f9e3dd7561d3dd91204cf546b7e">rhs</a>.get());</div>
<div class="line">    <span class="keyword">auto</span> u = vec::create(exec, <a class="code" href="structgko_1_1dim.html">gko::dim&lt;2&gt;</a>(discretization_points, 1));</div>
<div class="line">    u-&gt;fill(0.0);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> A = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">share</a>(mtx::create(</div>
<div class="line">        exec, <a class="code" href="structgko_1_1dim.html">gko::dim&lt;2&gt;</a>{discretization_points, discretization_points}));</div>
<div class="line">    generate_stencil_matrix(A.get());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> RealValueType reduction_factor{1e-7};</div>
<div class="line">    cg::build()</div>
<div class="line">        .with_criteria(</div>
<div class="line">            gko::stop::Iteration::build().with_max_iters(discretization_points),</div>
<div class="line">            <a class="code" href="classgko_1_1stop_1_1ResidualNorm.html">gko::stop::ResidualNorm&lt;ValueType&gt;::build</a>().with_reduction_factor(</div>
<div class="line">                reduction_factor))</div>
<div class="line">        .with_preconditioner(bj::build())</div>
<div class="line">        .on(exec)</div>
<div class="line">        -&gt;generate(A)</div>
<div class="line">        -&gt;apply(rhs, u);</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;\nSolve complete.&quot;</span></div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;\nThe average relative error is &quot;</span></div>
<div class="line">              &lt;&lt; calculate_error(discretization_points, u.get(), correct_u) /</div>
<div class="line">                     discretization_points</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="aclassgko_1_1matrix_1_1Csr_html"><div class="ttname"><a href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr</a></div><div class="ttdoc">CSR is a matrix format which stores only the nonzero coefficients by compressing each row of the matr...</div><div class="ttdef"><b>Definition:</b> matrix.hpp:27</div></div>
<div class="ttc" id="aclassgko_1_1matrix_1_1Dense_html"><div class="ttname"><a href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense</a></div><div class="ttdoc">Dense is a matrix format which explicitly stores all values of the matrix.</div><div class="ttdef"><b>Definition:</b> dense_cache.hpp:20</div></div>
<div class="ttc" id="anamespacegko_html_a6e5c95df0ae4e47aab2f604a22d98ee7"><div class="ttname"><a href="namespacegko.html#a6e5c95df0ae4e47aab2f604a22d98ee7">gko::size_type</a></div><div class="ttdeci">std::size_t size_type</div><div class="ttdoc">Integral type used for allocation quantities.</div><div class="ttdef"><b>Definition:</b> types.hpp:108</div></div>
<div class="ttc" id="aclassgko_1_1preconditioner_1_1Jacobi_html"><div class="ttname"><a href="classgko_1_1preconditioner_1_1Jacobi.html">gko::preconditioner::Jacobi</a></div><div class="ttdoc">A block-Jacobi preconditioner is a block-diagonal linear operator, obtained by inverting the diagonal...</div><div class="ttdef"><b>Definition:</b> jacobi.hpp:185</div></div>
<div class="ttc" id="aclassgko_1_1array_html"><div class="ttname"><a href="classgko_1_1array.html">gko::array</a></div><div class="ttdoc">An array is a container which encapsulates fixed-sized arrays, stored on the Executor tied to the arr...</div><div class="ttdef"><b>Definition:</b> array.hpp:27</div></div>
<div class="ttc" id="aclassgko_1_1stop_1_1ResidualNorm_html"><div class="ttname"><a href="classgko_1_1stop_1_1ResidualNorm.html">gko::stop::ResidualNorm</a></div><div class="ttdoc">The ResidualNorm class is a stopping criterion which stops the iteration process when the actual resi...</div><div class="ttdef"><b>Definition:</b> residual_norm.hpp:110</div></div>
<div class="ttc" id="astructgko_1_1dim_html"><div class="ttname"><a href="structgko_1_1dim.html">gko::dim&lt; 2 &gt;</a></div></div>
<div class="ttc" id="aclassgko_1_1solver_1_1Cg_html"><div class="ttname"><a href="classgko_1_1solver_1_1Cg.html">gko::solver::Cg</a></div><div class="ttdoc">CG or the conjugate gradient method is an iterative type Krylov subspace method which is suitable for...</div><div class="ttdef"><b>Definition:</b> cg.hpp:46</div></div>
<div class="ttc" id="anamespacegko_html_a3ce296f73db0ff398bdea6009a3a5c58"><div class="ttname"><a href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">gko::share</a></div><div class="ttdeci">detail::shared_type&lt; OwningPointer &gt; share(OwningPointer &amp;&amp;p)</div><div class="ttdoc">Marks the object pointed to by p as shared.</div><div class="ttdef"><b>Definition:</b> utils_helper.hpp:226</div></div>
<div class="ttc" id="anamespacegko_1_1solver_html_a82d21321745fbd3dc65c276d5838bb8aa83ff9f9e3dd7561d3dd91204cf546b7e"><div class="ttname"><a href="namespacegko_1_1solver.html#a82d21321745fbd3dc65c276d5838bb8aa83ff9f9e3dd7561d3dd91204cf546b7e">gko::solver::initial_guess_mode::rhs</a></div><div class="ttdoc">the input is right hand side</div></div>
<div class="ttc" id="aclassgko_1_1PolymorphicObject_html_ab40586bff071b7f11c2cf6b5cbf598eb"><div class="ttname"><a href="classgko_1_1PolymorphicObject.html#ab40586bff071b7f11c2cf6b5cbf598eb">gko::PolymorphicObject::get_executor</a></div><div class="ttdeci">std::shared_ptr&lt; const Executor &gt; get_executor() const noexcept</div><div class="ttdoc">Returns the Executor of the object.</div><div class="ttdef"><b>Definition:</b> polymorphic_object.hpp:235</div></div>
<div class="ttc" id="aclassgko_1_1LinOp_html_a31b3c003388eb0b95393154f68c2b98d"><div class="ttname"><a href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">gko::LinOp::get_size</a></div><div class="ttdeci">const dim&lt; 2 &gt; &amp; get_size() const noexcept</div><div class="ttdoc">Returns the size of the operator.</div><div class="ttdef"><b>Definition:</b> lin_op.hpp:211</div></div>
<div class="ttc" id="anamespacegko_html_afd46d554050c4ae90e84ea4fcd9a41f3"><div class="ttname"><a href="namespacegko.html#afd46d554050c4ae90e84ea4fcd9a41f3">gko::remove_complex</a></div><div class="ttdeci">typename detail::remove_complex_s&lt; T &gt;::type remove_complex</div><div class="ttdoc">Obtain the type which removed the complex of complex/scalar type or the template parameter of class b...</div><div class="ttdef"><b>Definition:</b> math.hpp:326</div></div>
<div class="ttc" id="aclassgko_1_1device__matrix__data_html"><div class="ttname"><a href="classgko_1_1device__matrix__data.html">gko::device_matrix_data</a></div><div class="ttdoc">This type is a device-side equivalent to matrix_data.</div><div class="ttdef"><b>Definition:</b> device_matrix_data.hpp:36</div></div>
<div class="ttc" id="aclassgko_1_1matrix_1_1Csr_html_ac4db41146ed3c3a8653b03d6b2c6c675"><div class="ttname"><a href="classgko_1_1matrix_1_1Csr.html#ac4db41146ed3c3a8653b03d6b2c6c675">gko::matrix::Csr::read</a></div><div class="ttdeci">void read(const mat_data &amp;data) override</div><div class="ttdoc">Reads a matrix from a matrix_data structure.</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
